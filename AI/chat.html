<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Vail AI</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/179893130?v=4">
    <link rel="apple-touch-icon" href="https://avatars.githubusercontent.com/u/179893130?v=4">

    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://kit.fontawesome.com/40440288c0.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        chatbg: {
                            light: '#ffffff',
                            dark: '#0d0d0d'
                        },
                        sidebar: {
                            light: '#f9f9f9',
                            dark: '#141414'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0, 0, 0.2, 1) forwards',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(12px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shimmer: {
                            '0%': { backgroundPosition: '200% 0' },
                            '100%': { backgroundPosition: '-200% 0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #8883; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #8885; }

        .prose { max-width: 100%; color: inherit; }
        .prose p { margin-bottom: 1.25rem; line-height: 1.7; }
        .prose pre { background: #1a1a1a; padding: 1.25rem; border-radius: 12px; overflow-x: auto; margin: 1rem 0; border: 1px solid rgba(255,255,255,0.05); }
        .prose code { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; padding: 0.2em 0.4em; border-radius: 4px; background: #8882; }
        .dark .prose pre { background: #000; border: 1px solid #222; }

        #sidebar { 
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), width 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
        }
        
        body.sidebar-collapsed #sidebar {
            width: 0;
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .history-item-active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6 !important;
            border-left: 3px solid #3b82f6;
        }

        .dropdown-menu { display: none; opacity: 0; transform: translateY(5px); transition: 0.2s ease; }
        .dropdown-menu.active { display: block; opacity: 1; transform: translateY(0); }

        .katex-display {
            margin: 1.5rem 0 !important;
            padding: 1.25rem;
            background: rgba(59, 130, 246, 0.03);
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        /* Modern Input Container (ChatGPT/Grok style) */
        .input-box-wrap {
            max-width: 48rem;
            margin: 0 auto;
            background: #f4f4f4;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 26px;
            transition: all 0.25s ease;
        }
        .dark .input-box-wrap {
            background: #1e1e1e;
            border-color: rgba(255,255,255,0.05);
        }
        .input-box-wrap:focus-within {
            background: #ffffff;
            border-color: rgba(0,0,0,0.15);
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }
        .dark .input-box-wrap:focus-within {
            background: #252525;
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
        }

        .user-msg-bubble { 
            background: #f4f4f4; 
            border-radius: 1.5rem; 
            padding: 0.85rem 1.25rem; 
            display: inline-block; 
            max-width: 85%; 
            color: #1a1a1a;
        }
        .dark .user-msg-bubble { background: #2f2f2f; color: #ececec; }

        /* Apple Intelligence Style Loader */
        .apple-loader {
            height: 3px;
            width: 140px;
            border-radius: 10px;
            background: linear-gradient(90deg, #4285f4, #9b51e0, #e91e63, #4285f4);
            background-size: 400% 100%;
            animation: shimmer 2.5s linear infinite;
        }
        
        .history-section-title {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #71717a;
            padding: 1.5rem 0.75rem 0.5rem;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .footer-padding {
            padding-bottom: max(1.5rem, env(safe-area-inset-bottom, 1.5rem));
        }

        #chat-messages {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-chatbg-light dark:bg-chatbg-dark text-zinc-900 dark:text-zinc-100 font-sans transition-colors duration-300 h-screen flex overflow-hidden">

    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/30 dark:bg-black/70 z-[45] hidden opacity-0 transition-opacity duration-300 lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 bg-sidebar-light dark:bg-sidebar-dark border-r border-zinc-200 dark:border-zinc-800 flex flex-col z-50 transform lg:translate-x-0">
        <div class="p-5 flex flex-col h-full text-zinc-900 dark:text-zinc-100">
            <!-- Branding Header -->
            <div class="mb-8 px-2 pt-2 flex items-center justify-between">
                <h1 class="font-extrabold text-2xl tracking-tighter uppercase italic">
                    V<span class="text-blue-500">AI</span>L
                </h1>
                <button class="lg:hidden p-2 text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100" onclick="toggleSidebar()">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <button id="new-chat-btn" class="w-full flex items-center justify-center gap-3 px-4 py-3.5 text-sm font-bold rounded-xl bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 shadow-xl transition-all active:scale-[0.96]">
                    <i class="fa-solid fa-plus text-xs"></i>
                    <span>New Chat</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto space-y-1 mb-4 custom-scrollbar" id="history-list">
                <!-- History Items -->
            </div>

            <div class="pt-4 border-t border-zinc-200 dark:border-zinc-800 space-y-1">
                <button id="theme-toggle" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-colors">
                    <i class="fa-solid fa-circle-half-stroke text-zinc-500"></i>
                    <span>Appearance</span>
                </button>
                <button id="clear-all-btn" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-red-500/80 rounded-xl hover:bg-red-500/10 transition-colors">
                    <i class="fa-solid fa-trash-can"></i>
                    <span>Clear All</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <!-- Top Nav -->
        <header class="h-16 flex items-center justify-between px-4 border-b border-zinc-200 dark:border-zinc-800 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md z-40">
            <div class="flex items-center gap-2">
                <button id="toggle-sidebar" class="p-2.5 text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars-staggered"></i>
                </button>
                
                <div class="relative text-zinc-900 dark:text-zinc-100">
                    <button id="model-dropdown-btn" class="flex items-center gap-2.5 px-3 py-2 text-sm font-bold rounded-xl hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all">
                        <div id="active-model-icon" class="w-4 h-4 text-zinc-700 dark:text-zinc-300"></div>
                        <span id="active-model-name">OLM North Star</span>
                        <i class="fa-solid fa-chevron-down text-[10px] opacity-40"></i>
                    </button>
                    <div id="model-menu" class="dropdown-menu absolute left-0 top-full mt-2 w-64 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 shadow-2xl rounded-2xl z-50 overflow-hidden">
                        <button id="model-select-pro" class="group w-full text-left px-5 py-4 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 border-b border-zinc-100 dark:border-zinc-800 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-5 h-5 text-blue-500" id="icon-pro-menu"></div>
                                <div>
                                    <span class="block font-bold">OLM North Star</span>
                                    <span class="text-xs text-zinc-500">Fast replies</span>
                                </div>
                            </div>
                        </button>
                        <button id="model-select-base" class="group w-full text-left px-5 py-4 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-5 h-5 text-zinc-500" id="icon-base-menu"></div>
                                <div>
                                    <span class="block font-bold">OLM Stargaze</span>
                                    <span class="text-xs text-zinc-500">Best model</span>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-1">
                <div id="api-status" class="hidden md:flex text-[10px] font-bold text-zinc-400 gap-2 items-center mr-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span> Standby
                </div>
                <button id="settings-toggle" class="p-2.5 text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-100">
                    <i class="fa-solid fa-sliders text-lg"></i>
                </button>
                <div id="settings-menu" class="dropdown-menu absolute right-4 top-16 w-80 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 shadow-2xl rounded-2xl p-6 z-50 text-zinc-900 dark:text-zinc-100">
                    <h3 class="font-bold text-base mb-5">Parameters</h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs font-bold mb-3 uppercase tracking-wider opacity-60">
                                <span>Entropy</span>
                                <span id="temp-val" class="font-mono text-blue-500">0.4</span>
                            </div>
                            <input type="range" id="param-temp" min="0" max="1" step="0.05" value="0.4" class="w-full h-2 bg-zinc-200 dark:bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>
                        <button id="save-settings" class="w-full py-3 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 text-xs font-black uppercase tracking-widest rounded-xl shadow-lg transition-transform active:scale-95">Sync Configuration</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Chat messages area -->
        <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col bg-chatbg-light dark:bg-chatbg-dark">
            <div id="welcome-state" class="flex-1 flex flex-col items-center justify-center p-6 text-center animate-fade-in">
                <h2 class="text-3xl md:text-5xl font-extrabold mb-4 tracking-tight text-zinc-900 dark:text-zinc-100">How can I help?</h2>
                <p class="text-zinc-400 text-base md:text-lg mb-10 max-w-sm font-medium">The OLM engine is ready for dispatch.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl">
                    <button class="p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 text-left bg-white dark:bg-zinc-900 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-all shadow-sm active:scale-[0.98] text-zinc-900 dark:text-zinc-100" onclick="sendMessage('Technical breakdown of quantum encryption protocols.')">
                        <span class="text-xs font-black uppercase tracking-widest block mb-2 text-blue-500 opacity-80">Research</span>
                        <span class="text-sm font-semibold opacity-70">Technical Analysis</span>
                    </button>
                    <button class="p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 text-left bg-white dark:bg-zinc-900 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-all shadow-sm active:scale-[0.98] text-zinc-900 dark:text-zinc-100" onclick="sendMessage('Help me brainstorm a brand identity for a new technology startup.')">
                        <span class="text-xs font-black uppercase tracking-widest block mb-2 text-purple-500 opacity-80">Creative</span>
                        <span class="text-sm font-semibold opacity-70">Strategic Strategy</span>
                    </button>
                </div>
            </div>
            <div id="chat-messages" class="w-full flex flex-col pt-8 pb-56 px-4 text-zinc-900 dark:text-zinc-100"></div>
        </div>

        <!-- Floating Footer -->
        <div class="absolute bottom-0 left-0 w-full footer-padding px-4 md:px-6 bg-gradient-to-t from-white dark:from-chatbg-dark via-white/95 dark:via-chatbg-dark/95 to-transparent z-30">
            <div class="input-box-wrap px-2 pt-2 pb-2 mb-2 md:mb-4">
                <textarea 
                    id="user-input" 
                    placeholder="Message OLM..." 
                    rows="1" 
                    class="w-full bg-transparent px-4 py-3 outline-none resize-none text-[16px] md:text-base max-h-60 custom-scrollbar leading-relaxed text-zinc-900 dark:text-zinc-100"
                ></textarea>
                
                <div class="flex items-center justify-between px-3 pb-1 mt-1 pointer-events-none">
                    <div class="flex items-center gap-2 pointer-events-auto">
                        <button id="input-search-toggle" class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-zinc-200 dark:border-zinc-700 text-[11px] font-bold uppercase tracking-wider text-zinc-500 hover:bg-white dark:hover:bg-zinc-800 transition-all active:scale-95 shadow-sm">
                            <i class="fa-solid fa-magnifying-glass text-[10px]"></i>
                            <span>Search</span>
                        </button>
                    </div>
                    <div class="flex gap-2 pointer-events-auto">
                        <button id="send-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-zinc-900 dark:bg-white text-white dark:text-black hover:opacity-85 disabled:opacity-20 transition-all shadow-md active:scale-90">
                            <i class="fa-solid fa-arrow-up text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-[9px] font-bold tracking-[0.2em] uppercase text-center text-zinc-400 mt-2 opacity-40">Intelligence Terminal v0.3.1</p>
        </div>

        <!-- Scroll Bottom -->
        <button id="scroll-bottom-btn" class="absolute bottom-44 right-6 md:right-10 w-11 h-11 rounded-full bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 shadow-xl flex items-center justify-center opacity-0 invisible translate-y-4 transition-all z-10 active:scale-90 text-zinc-500">
            <i class="fa-solid fa-arrow-down"></i>
        </button>
    </main>

    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

        // North Star Icon
        const NORTH_STAR_SVG = `<svg class="w-full h-full stroke-[2.5px] stroke-current fill-none" viewBox="0 0 24 24"><path d="M12 2V22M2 12H22M19.07 4.93L4.93 19.07M19.07 19.07L4.93 4.93" /><circle cx="12" cy="12" r="3" class="fill-current stroke-none" /></svg>`;
        
        // Stargaze Icon
        const STARGAZE_SVG = `<svg class="w-full h-full stroke-[3px] stroke-current fill-none" viewBox="0 0 24 24"><path d="M12 2L13.5 10.5L22 12L13.5 13.5L12 22L10.5 13.5L2 12L10.5 10.5L12 2Z" /></svg>`;

        const MODELS = {
            OLM1: { id: "https://ar12c-okemo2.hf.space", name: "OLM Stargaze", schema: "legacy", icon: STARGAZE_SVG },
            OLM2: { id: "ar12c/OkemoLLM", name: "OLM North Star", schema: "modern", icon: NORTH_STAR_SVG }
        };

        const SYSTEM_PROMPT = "You are Vail AI, an elite intelligence engine. Provide precise and comprehensive responses. CRITICAL: ALWAYS wrap equations in $$ tags only and DO NOT under any circumstances give parentheses or square brackets.";
        const WEB_TOKEN = "<WEB>";

        let currentModel = MODELS.OLM2;
        let client = null;
        let history = []; 
        let allChats = JSON.parse(localStorage.getItem('olm_archives_v5') || '{}');
        let currentChatId = crypto.randomUUID();
        let isGenerating = false;
        let webSearchEnabled = false;
        let settings = JSON.parse(localStorage.getItem('olm_settings_v4') || JSON.stringify({ temp: 0.4, tokens: 1024, top_p: 0.85, penalty: 1.2 }));

        const chatBoxContainer = document.getElementById("chat-container");
        const chatBox = document.getElementById("chat-messages");
        const textarea = document.getElementById("user-input");
        const sendBtn = document.getElementById("send-btn");
        const statusEl = document.getElementById("api-status");
        const welcomeState = document.getElementById("welcome-state");
        const historyList = document.getElementById("history-list");
        const modelMenu = document.getElementById("model-menu");
        const settingsMenu = document.getElementById("settings-menu");
        const scrollBottomBtn = document.getElementById('scroll-bottom-btn');
        const inputSearchToggle = document.getElementById('input-search-toggle');
        const activeModelIcon = document.getElementById('active-model-icon');

        function formatMarkdown(input) {
            if (input === null || input === undefined) return '';
            let textToParse = '';
            
            if (typeof input === 'string') {
                textToParse = input;
            } else if (Array.isArray(input)) {
                const lastEntry = input[input.length - 1];
                textToParse = String(Array.isArray(lastEntry) ? (lastEntry[1] || '') : (lastEntry || ''));
            } else if (typeof input === 'object') {
                if (input.type === 'update') return ''; 
                textToParse = String(input.message || input.text || input.data || "");
            }
            
            if (!textToParse || textToParse === "[object Object]") return "";
            return marked.parse(textToParse);
        }

        function renderMath(container) {
            const blockRegex = /\$\$([\s\S]+?)\$\$/g;
            container.innerHTML = container.innerHTML.replace(blockRegex, (match, formula) => {
                try {
                    return `<div class="katex-display">` + 
                           katex.renderToString(formula, { displayMode: true, throwOnError: false }) + 
                           `</div>`;
                } catch (e) { return match; }
            });
        }

        function setStatus(msg = "", color = "green") {
            if (!statusEl) return;
            const colorClassMap = { 'green': 'bg-emerald-500', 'red': 'bg-red-500', 'yellow': 'bg-amber-500', 'blue': 'bg-blue-500' };
            statusEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full ${colorClassMap[color] || 'bg-zinc-300'}"></span> ${msg}`;
        }

        function updateTopNavIcon() {
            if (activeModelIcon) activeModelIcon.innerHTML = currentModel.icon;
            document.getElementById('icon-pro-menu').innerHTML = MODELS.OLM2.icon;
            document.getElementById('icon-base-menu').innerHTML = MODELS.OLM1.icon;
        }

        function toggleSearch(force) {
            webSearchEnabled = force !== undefined ? force : !webSearchEnabled;
            inputSearchToggle.className = `flex items-center gap-2 px-3.5 py-1.5 rounded-full border transition-all text-[11px] font-bold uppercase tracking-wider ${webSearchEnabled ? 'bg-blue-500 border-blue-500 text-white shadow-lg' : 'border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:bg-white dark:hover:bg-zinc-800'}`;
        }

        async function ensureClient() {
            if (client) return client;
            setStatus("Connecting...", "yellow");
            try {
                client = await Client.connect(currentModel.id);
                setStatus("Standby", "green");
                return client;
            } catch (err) {
                setStatus("Offline", "red");
                throw err;
            }
        }

        function saveToStorage(targetChatId, targetHistory) {
            const idToSave = targetChatId || currentChatId;
            const historyToSave = targetHistory || history;
            if (!historyToSave || historyToSave.length === 0) return;
            const firstMsgItem = historyToSave[0][0];
            const firstMsg = typeof firstMsgItem === 'string' ? firstMsgItem : "New Chat";
            const title = firstMsg.substring(0, 30) + (firstMsg.length > 30 ? '...' : '');
            const existingPinned = allChats[idToSave]?.pinned || false;
            allChats[idToSave] = { id: idToSave, title: title, history: JSON.parse(JSON.stringify(historyToSave)), pinned: existingPinned, timestamp: Date.now() };
            localStorage.setItem('olm_archives_v5', JSON.stringify(allChats));
            renderHistory();
        }

        async function sendMessage(overrideText = null) {
            if (isGenerating) return;
            let msg = overrideText ?? textarea.value.trim();
            if (!msg) return;

            if (!overrideText) textarea.value = "";
            textarea.style.height = "auto";
            if (webSearchEnabled && !msg.includes(WEB_TOKEN)) msg += ` ${WEB_TOKEN}`;
            
            history.push([msg, null]);
            const processingChatId = currentChatId; 
            const activeHistory = history; 
            
            render();
            scrollToBottom();
            isGenerating = true;
            sendBtn.disabled = true;

            try {
                const c = await ensureClient();
                let job;
                
                if (currentModel.schema === "legacy") {
                    job = c.submit(0, [msg, activeHistory.map(([u, a]) => [u, a])]);
                } else {
                    job = c.submit(0, [
                        msg, 
                        activeHistory.slice(0, -1), 
                        settings.temp, 
                        settings.top_p, 
                        settings.penalty, 
                        settings.tokens
                    ]);
                }

                for await (const chunk of job) {
                    if (!chunk?.data || chunk.data.length === 0) continue;
                    
                    let responseText = "";
                    const rawData = chunk.data[0];

                    if (typeof rawData === 'object' && rawData !== null && rawData.type === 'update') continue;

                    if (currentModel.schema === "legacy") {
                        const lastPair = rawData[rawData.length - 1];
                        responseText = String(lastPair[1] || "");
                    } else {
                        if (typeof rawData === 'string') responseText = rawData;
                        else if (Array.isArray(rawData)) {
                            const last = rawData[rawData.length - 1];
                            responseText = String(Array.isArray(last) ? (last[1] || '') : (last || ''));
                        } else if (rawData && typeof rawData === 'object') {
                            responseText = String(rawData.message || rawData.text || "");
                        }
                    }
                    
                    if (responseText && responseText !== "[object Object]") {
                        activeHistory[activeHistory.length - 1][1] = responseText;
                        if (currentChatId === processingChatId) updateLastResponseInUI(responseText);
                    }
                }
            } catch (e) {
                console.error("API Failure:", e);
                const hexCode = Math.floor(Math.random()*16777215).toString(16).toUpperCase();
                activeHistory.at(-1)[1] = `⚠️ **[ERR_SYNTHESIS_FAILURE]** 0x${hexCode}: Trace aborted. (Native: ${e.message || "null"})`;
                if (currentChatId === processingChatId) render();
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                saveToStorage(processingChatId, activeHistory); 
                if (currentChatId === processingChatId) { render(); scrollToBottom(); }
            }
        }

        window.sendMessage = sendMessage;

        function updateLastResponseInUI(text) {
            const aiRows = chatBox.querySelectorAll('.ai-row');
            if (aiRows.length === 0) return;
            const lastRow = aiRows[aiRows.length - 1];
            const proseDiv = lastRow.querySelector('.prose');
            if (proseDiv) {
                const html = formatMarkdown(text);
                if (html) {
                    proseDiv.innerHTML = html;
                    renderMath(proseDiv);
                }
            }
        }

        window.__okemoCopy = (idx) => {
            const text = history[idx]?.[1];
            if (!text) return;
            navigator.clipboard.writeText(String(text)).then(() => setStatus("Inscribed", "blue"));
        };

        window.__okemoRegen = (idx) => {
            if (isGenerating) return;
            const msg = history[idx]?.[0];
            if (!msg) return;
            history = history.slice(0, idx);
            render();
            sendMessage(msg);
        };

        window.__okemoDeleteChat = (id) => {
            delete allChats[id];
            localStorage.setItem('olm_archives_v5', JSON.stringify(allChats));
            if (currentChatId === id) resetChat();
            else renderHistory();
        };
        
        window.__okemoTogglePin = (id) => {
            if (allChats[id]) {
                allChats[id].pinned = !allChats[id].pinned;
                localStorage.setItem('olm_archives_v5', JSON.stringify(allChats));
                renderHistory();
            }
        };

        function render() {
            if (history.length === 0) {
                welcomeState.style.display = "flex";
                chatBox.style.display = "none";
                chatBox.innerHTML = "";
                return;
            } else {
                welcomeState.style.display = "none";
                chatBox.style.display = "flex";
            }

            chatBox.innerHTML = "";
            history.forEach(([u, a], idx) => {
                const uDiv = document.createElement('div');
                uDiv.className = "mb-8 flex flex-col items-end animate-slide-up";
                uDiv.innerHTML = `
                    <div class="message-content flex flex-col items-end">
                        <div class="user-msg-bubble mr-2 md:mr-4">
                            <div class="text-[15px] leading-relaxed">${marked.parse(String(u))}</div>
                        </div>
                    </div>`;
                chatBox.appendChild(uDiv);

                const aiDiv = document.createElement('div');
                aiDiv.className = "ai-row mb-12 animate-slide-up group";
                aiDiv.innerHTML = `
                    <div class="message-content flex gap-5">
                        <div class="w-10 h-10 p-2 rounded-2xl bg-zinc-100 dark:bg-zinc-800 flex-shrink-0 flex items-center justify-center border border-zinc-200 dark:border-zinc-700 shadow-sm text-zinc-800 dark:text-zinc-100">
                             ${currentModel.icon}
                        </div>
                        <div class="flex-1 overflow-hidden pt-1.5">
                            <div class="prose dark:prose-invert">
                                ${a ? formatMarkdown(a) : '<div class="apple-loader mt-4"></div>'}
                            </div>
                            ${a ? `
                            <div class="flex gap-4 mt-8 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.__okemoCopy(${idx})" class="text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"><i class="fa-regular fa-copy text-sm"></i></button>
                                <button onclick="window.__okemoRegen(${idx})" class="text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"><i class="fa-solid fa-rotate-right text-sm"></i></button>
                            </div>` : ''}
                        </div>
                    </div>`;
                chatBox.appendChild(aiDiv);
                if (a) renderMath(aiDiv.querySelector('.prose'));
            });
        }

        function createHistoryItem(chat) {
            const isActive = chat.id === currentChatId;
            const item = document.createElement("button");
            item.className = `w-full text-left px-4 py-3 rounded-2xl text-[13px] font-semibold transition-all truncate flex items-center justify-between group ${isActive ? 'history-item-active' : 'text-zinc-500 hover:bg-zinc-200 dark:hover:bg-zinc-800'}`;
            const pinClass = chat.pinned ? 'text-blue-500 opacity-100' : 'opacity-0 lg:group-hover:opacity-40 hover:!opacity-100';
            const trashClass = 'opacity-0 lg:group-hover:opacity-40 hover:!opacity-100';
            item.innerHTML = `<span class="truncate pointer-events-none">${chat.title}</span><div class="flex items-center gap-1 text-zinc-400"><button class="p-1 transition-all ${pinClass}" onclick="event.stopPropagation(); window.__okemoTogglePin('${chat.id}')"><i class="fa-solid fa-thumbtack text-[11px]"></i></button><button class="p-1 transition-all ${trashClass}" onclick="event.stopPropagation(); window.__okemoDeleteChat('${chat.id}')"><i class="fa-solid fa-trash-can text-[11px]"></i></button></div>`;
            item.onclick = () => { currentChatId = chat.id; history = JSON.parse(JSON.stringify(chat.history)); isGenerating = false; render(); renderHistory(); if (window.innerWidth < 1024) toggleSidebar(); };
            return item;
        }

        function renderHistory() {
            historyList.innerHTML = "";
            const chats = Object.values(allChats).sort((a, b) => b.timestamp - a.timestamp);
            const pinned = chats.filter(c => c.pinned);
            const recent = chats.filter(c => !c.pinned);
            if (pinned.length > 0) {
                const title = document.createElement("div"); title.className = "history-section-title"; title.innerText = "Pinned"; historyList.appendChild(title);
                pinned.forEach(chat => historyList.appendChild(createHistoryItem(chat)));
            }
            if (recent.length > 0) {
                const title = document.createElement("div"); title.className = "history-section-title"; title.innerText = "Recent"; historyList.appendChild(title);
                recent.forEach(chat => historyList.appendChild(createHistoryItem(chat)));
            }
        }

        function resetChat() { currentChatId = crypto.randomUUID(); history = []; isGenerating = false; document.getElementById('active-model-name').innerText = currentModel.name; updateTopNavIcon(); setStatus("Ready", "green"); render(); renderHistory(); if (window.innerWidth < 1024) toggleSidebar(); }

        window.toggleSidebar = () => {
            const body = document.body;
            const isDesktop = window.innerWidth >= 1024;
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            if (isDesktop) body.classList.toggle('sidebar-collapsed');
            else {
                const isHidden = sidebar.classList.contains('-translate-x-full');
                if (isHidden) { sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden'); setTimeout(() => backdrop.style.opacity = '1', 10); }
                else { sidebar.classList.add('-translate-x-full'); backdrop.style.opacity = '0'; setTimeout(() => backdrop.classList.add('hidden'), 300); }
            }
        };

        function scrollToBottom() { chatBoxContainer.scrollTo({ top: chatBoxContainer.scrollHeight, behavior: 'smooth' }); }

        function initEventListeners() {
            sendBtn.addEventListener('click', () => sendMessage());
            textarea.addEventListener('keydown', e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            textarea.addEventListener('input', function() { 
                this.style.height = 'auto'; 
                this.style.height = (this.scrollHeight > 240 ? 240 : this.scrollHeight) + 'px'; 
            });
            document.getElementById('model-dropdown-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsMenu.classList.remove('active'); modelMenu.classList.toggle('active'); });
            document.getElementById('settings-toggle').addEventListener('click', (e) => { e.stopPropagation(); modelMenu.classList.remove('active'); settingsMenu.classList.toggle('active'); });
            window.addEventListener('click', (e) => { if (!modelMenu.contains(e.target) && !settingsMenu.contains(e.target)) { modelMenu.classList.remove('active'); settingsMenu.classList.remove('active'); } });
            document.getElementById('model-select-pro').addEventListener('click', () => { if (history.length > 0) resetChat(); currentModel = MODELS.OLM2; client = null; document.getElementById('active-model-name').innerText = MODELS.OLM2.name; updateTopNavIcon(); modelMenu.classList.remove('active'); ensureClient(); });
            document.getElementById('model-select-base').addEventListener('click', () => { if (history.length > 0) resetChat(); currentModel = MODELS.OLM1; client = null; document.getElementById('active-model-name').innerText = MODELS.OLM1.name; updateTopNavIcon(); modelMenu.classList.remove('active'); ensureClient(); });
            inputSearchToggle.addEventListener('click', () => toggleSearch());
            document.getElementById('theme-toggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('vail_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); });
            document.getElementById('new-chat-btn').addEventListener('click', resetChat);
            document.getElementById('save-settings').addEventListener('click', () => { settings.temp = parseFloat(document.getElementById('param-temp').value); localStorage.setItem('olm_settings_v4', JSON.stringify(settings)); settingsMenu.classList.remove('active'); setStatus("Syncing...", "blue"); setTimeout(() => setStatus("Standby", "green"), 500); });
            document.getElementById('param-temp').addEventListener('input', (e) => { document.getElementById('temp-val').innerText = e.target.value; });
            document.getElementById('clear-all-btn').addEventListener('click', () => { allChats = {}; localStorage.setItem('olm_archives_v5', '{}'); resetChat(); });
            chatBoxContainer.addEventListener('scroll', () => {
                const threshold = 300;
                const isScrolledUp = chatBoxContainer.scrollHeight - chatBoxContainer.scrollTop - chatBoxContainer.clientHeight > threshold;
                if (isScrolledUp) { scrollBottomBtn.classList.remove('opacity-0', 'invisible', 'translate-y-4'); scrollBottomBtn.classList.add('opacity-100', 'visible', 'translate-y-0'); }
                else { scrollBottomBtn.classList.add('opacity-0', 'invisible', 'translate-y-4'); scrollBottomBtn.classList.remove('opacity-100', 'visible', 'translate-y-0'); }
            });
            scrollBottomBtn.addEventListener('click', scrollToBottom);
        }

        function initApp() {
            const savedTheme = localStorage.getItem('vail_theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
            if (window.innerWidth < 1024) document.getElementById('sidebar').classList.add('-translate-x-full');
            const tempInput = document.getElementById('param-temp');
            if (tempInput) { tempInput.value = settings.temp; document.getElementById('temp-val').innerText = settings.temp; }
            initEventListeners(); updateTopNavIcon(); renderHistory(); render(); ensureClient().catch(() => setStatus("Offline", "red"));
        }
        initApp();
    </script>
</body>
</html>

