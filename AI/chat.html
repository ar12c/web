<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chat OLM</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://kit.fontawesome.com/40440288c0.js" crossorigin="anonymous"></script>

    <link rel="Shortcut icon" type="x-icon" href="/images/blehfile.png">
    <meta content="OkemoVail" property="og:title">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Modernized Styles for a cleaner, Gemini/ChatGPT aesthetic */
        .chat-scroll { 
            scroll-behavior: smooth; 
            overflow-x: hidden;
            /* FIX: Remove fixed background color to make it transparent/inherit body background */
            background-color: transparent !important; 
            filter: var(--chat-bg-filter, none);
        }
        
        /* --- Loading Animation Styles (Line) */
        @keyframes loading-line {
            0% {
                transform: translateX(-100%) scaleX(0.1);
            }
            50% {
                transform: translateX(0%) scaleX(0.5);
            }
            100% {
                transform: translateX(100%) scaleX(0.1);
            }
        }

        .loading-line-animation {
            animation: loading-line 2s cubic-bezier(0.65, 0.815, 0.735, 0.395) infinite;
            transform-origin: left;
        }

        /* Custom Transition for Dropdown Arrow */
        #menu-toggle i, #plus-icon {
            transition: transform 0.3s ease-in-out;
        }
        #menu-toggle.active i {
            transform: rotate(180deg);
        }
        
        /* Plus icon rotation for menu open */
        #plus-menu-toggle.active #plus-icon {
            transform: rotate(45deg); 
        }

        /* Input Area Layout */
        #input-bar-container {
            display: grid;
            grid-template-columns: 1fr auto; 
            align-items: end; 
            /* Grid layout now covers two rows to stack file preview above text area */
            grid-template-rows: auto 1fr;
        }
        
        #file-preview-container {
            grid-column: 1 / span 2; 
            grid-row: 1; 
            padding: 0 16px; /* Match left/right padding of textarea */
            padding-top: 10px;
            z-index: 10;
        }
        
        #okemo-input {
            grid-row: 2; 
            grid-column: 1;
            padding: 12px 16px; 
            min-height: 48px; 
            max-height: 200px;
            /* Flex to center text vertically */
            display: flex; 
            align-items: center;
        }

        #s-wrapper {
            grid-row: 2; 
            grid-column: 2;
            display: flex;
            align-items: flex-end; /* Align to the bottom of the input container */
            gap: 4px; 
            margin-right: 4px; 
            margin-bottom: 4px; /* Ensure buttons are slightly raised */
        }
        
        /* Center the big welcome prompt */
        #empty-chat-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            transition: opacity 0.3s ease-in-out;
        }
        
        /* --- UPDATE BADGE (Simplified) --- */
        .update-badge {
            position: absolute;
            top: 2px; 
            left: 100%; 
            margin-left: 0px; 
            width: 8px;
            height: 8px;
            background-color: #ef4444; /* Tailwind red-500 */
            border-radius: 50%;
            border: 2px solid #ffffff; /* light background (white) */
            .dark & { border-color: #111827; } /* dark background (neutral-900) */
        }

        /* Chat Message Specific Styling */
        /* AI Message Container */
        .ai-message-row {
            padding: 16px 0; /* Padding for the entire block */
            border-bottom: 1px solid #e5e7eb; /* Subtle separator */
            .dark & { border-bottom-color: #374151; }
        }
        
        /* AI Text Content */
        .ai-message-row > div:nth-child(2) {
            /* Max width for AI text */
            max-width: calc(100% - 40px); /* 8px padding + 32px icon width + 4px gap */
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve whitespace/newlines for responses */
        }

        /* User Message Container */
        .user-message-row {
            /* Full width block for User response background */
            background-color: transparent; /* Makes the whole row blend with body background */
        }

        /* User Message Bubble */
        .user-message-row > div {
            /* FIX: New User Bubble Colors (neutral-200/neutral-800 with correct text colors) */
            background-color: #e5e7eb; /* neutral-200 in light mode */
            color: #171717; /* neutral-900 (dark text) in light mode */
            border-radius: 1.5rem 0.5rem 1.5rem 1.5rem; /* Smoother corner for human bubble */
        }
        .dark .user-message-row > div {
             background-color: #3f3f46; /* neutral-800 in dark mode */
             color: white; /* white text in dark mode */
        }
        
        /* AI Logo (Placeholder: 'O' for OLM) */
        .ai-logo-placeholder {
            min-width: 32px;
            min-height: 32px;
            border-radius: 9999px;
            /* Black background, white text for light mode */
            background-color: #171717; /* Neutral 900 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
        }
        /* In dark mode, invert the logo color for contrast against the dark background */
        .dark .ai-logo-placeholder {
            background-color: white;
            color: #171717; /* Neutral 900 */
        }
    </style>
</head>
<!-- FIX: Changed body background to neutral-100/900 for Light/Dark Mode separation -->
<body class="bg-neutral-100 dark:bg-neutral-900 min-h-screen font-inter flex flex-col transition-colors duration-300 text-neutral-800 dark:text-neutral-200">
    
    <!-- Modals -->
    <div id="disclaimer-modal" class="fixed inset-0 bg-neutral-900/40 dark:bg-neutral-800/70 flex items-center justify-center z-50 transition-opacity duration-300 hidden backdrop-blur-sm">
        <div class="bg-white dark:bg-neutral-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold mb-4 text-neutral-900 dark:text-white transition-all duration-300">Okemo Disclaimer</h3>
            <div class="text-neutral-600 dark:text-neutral-400 mb-6 text-sm space-y-3 transition-all duration-300">
                <p>OkemoLLM is currently in public beta. All of its generated content may be inaccurate, incomplete, or biased.</p>
                <p class="font-semibold text-neutral-800 dark:text-neutral-300 transition-all duration-300">By clicking Agree:</p>
                <ul class="list-disc list-inside ml-2 space-y-1">
                    <li>Your input is logged and used to improve the model.</li>
                    <li>This service is extremely unsecure.</li>
                    <li>Your conversations may or may not be shared around the internet.</li>
                </ul>
                <p class="mt-4 text-base font-bold text-red-600 transition-all duration-300">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> PLEASE AVOID SHARING SENSITIVE INFORMATION.
                </p>
            </div>
            
            <div class="flex items-center mb-4 transition-all duration-300">
                <input type="checkbox" id="dont-show-again" class="w-4 h-4 text-neutral-600 bg-neutral-100 dark:bg-neutral-700 border-none rounded focus:ring-neutral-500 transition-all duration-300 accent-neutral-500">
                <label for="dont-show-again" class="ml-2 text-sm font-medium text-neutral-700 dark:text-neutral-300 transition-all duration-300">Don't show this again</label>
            </div>

            <div class="flex gap-4 transition-all duration-300">
                <button 
                    id="disclaimer-agree" 
                    class="w-full py-2 bg-neutral-900 dark:bg-white text-white dark:text-black font-semibold rounded-xl hover:bg-neutral-800 dark:hover:bg-neutral-100 transition duration-300"
                >
                    Agree
                </button>
                <a href="#"
                    class="block w-full py-2 border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-800 dark:text-white font-semibold rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-700 transition duration-300 text-center">
                    Disagree
                </a>

            </div>
        </div>
    </div>
    
    <div id="bad-feedback-modal"
     class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden z-[1000] transition-opacity duration-300 opacity-0">
        <div class="bg-white dark:bg-neutral-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 relative">
            <h2 class="text-lg font-semibold mb-3 dark:text-white">Bad Response Feedback</h2>
            <p class="text-sm text-neutral-600 dark:text-neutral-300 mb-4">
                What should the prompt have been instead?
            </p>
            <textarea id="bad-feedback-input"
                    class="w-full h-24 border border-neutral-300 dark:border-neutral-700 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-neutral-500 dark:bg-neutral-900 dark:text-white"
                    placeholder="Enter your suggested prompt..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-bad-feedback"
                        class="px-4 py-2 rounded-xl bg-neutral-200 hover:bg-neutral-300 text-neutral-800 text-sm transition">
                    Cancel
                </button>
                <button id="submit-bad-feedback"
                        class="px-4 py-2 bg-neutral-900 dark:bg-white text-white dark:text-black font-semibold rounded-xl hover:bg-neutral-800 dark:hover:bg-neutral-100 transition duration-300">
                    Submit
                </button>
            </div>
        </div>
    </div>
    
    <div id="update-notes-modal" class="fixed inset-0 bg-neutral-900/40 dark:bg-neutral-800/70 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 hidden backdrop-blur-sm">        
        <div class="bg-white dark:bg-neutral-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold mb-4 text-neutral-900 dark:text-white flex items-center transition-all duration-300">
                <i class="fa-solid fa-bell text-neutral-600 dark:text-neutral-400 mr-2 transition-all duration-300"></i> What's New!
            </h3>
            <div class="text-neutral-600 dark:text-neutral-400 mb-6 text-sm space-y-4 transition-all duration-300">
                <h4 class="text-lg font-semibold text-neutral-800 dark:text-white transition-all duration-300">
                    Version 0.1.2 - October 2025
                </h4>
                <ul class="list-disc list-inside ml-2 space-y-2 text-neutral-700 dark:text-neutral-400 transition-all duration-300">
                    <li>Better responses: More humanly understandable responses</li>
                    <li>Web search: Learning from the web</li>
                    <li>File/Photo: OkemoLLM can now see your photos and files</li>
                </ul>
            </div>
            
            <div class="flex items-center mb-4 transition-all duration-300">
                <input type="checkbox" id="notes-dont-show-again" class="w-4 h-4 text-neutral-600 bg-neutral-100 dark:bg-neutral-700 border-none rounded focus:ring-neutral-500 transition-all duration-300 accent-neutral-500">
                <label for="notes-dont-show-again" class="ml-2 text-sm font-medium text-neutral-700 dark:text-neutral-300 transition-all duration-300">Don't show this version's notes again</label>
            </div>

            <button 
                id="update-notes-close" 
                class="w-full py-2 bg-neutral-900 dark:bg-white text-white dark:text-black font-semibold rounded-xl hover:bg-neutral-800 dark:hover:bg-neutral-100 transition duration-300"
            >
                Got It!
            </button>
        </div>
    </div>

    <!-- Fixed Header -->
    <div id="fixed-header-wrapper" class="fixed top-0 left-0 right-0 z-30 bg-white/80 dark:bg-neutral-900/90 backdrop-blur-md transition-colors duration-300 border-b border-neutral-200 dark:border-neutral-800">
        <div class="w-full mx-auto max-w-2xl px-4 sm:px-8"> 
            <header class="py-3 flex items-center justify-between relative transition-all duration-300"> 
                <div class="flex items-center relative transition-all duration-300">
                    <a href="#" id="okemo-title" class="text-xl font-semibold cursor-pointer text-neutral-900 dark:text-white transition-all duration-300">
                        OLM
                    </a>
                    <span id="update-note-badge" class="update-badge hidden"></span>
                    <button id="menu-toggle" class="ml-1 text-base text-neutral-700 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition p-1 rounded-full duration-300">
                        <i class="fa-solid fa-caret-down transition duration-150 transform" id="menu-icon"></i>
                    </button>
                </div>
                
                <a href="#" id="new-chat-link-header" class="text-sm rounded-xl bg-neutral-900 dark:bg-white hover:bg-neutral-800 dark:hover:bg-neutral-100 text-white dark:text-black p-2 px-3 transition-all duration-300">
                    <i class="fa-regular fa-message mr-1"></i> New Chat
                </a>

                <div id="okemo-dropdown" class="absolute left-0 top-[calc(100%+10px)] w-48 bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl shadow-xl z-10 hidden p-1 transform opacity-0 scale-y-0 transition-all duration-200 ease-out origin-top">
                    
                    <a href="#" id="new-chat-dropdown-1" class="relative flex items-center px-3 py-2 text-neutral-800 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition duration-300">
                        <i class="fa-regular fa-square-plus mr-2 w-4 text-center text-neutral-600 dark:text-neutral-300"></i> New Chat (Duplicate)
                    </a>
                    <a href="#" id="new-chat-dropdown-2" class="relative flex items-center px-3 py-2 text-neutral-800 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition duration-300">
                        <i class="fas fa-code-branch mr-2 w-4 text-center text-neutral-600 dark:text-neutral-300"></i> OLM 1 (Legacy)
                    </a>
                    <div class="my-1 border-t border-neutral-100 dark:border-neutral-700 transition-all duration-300"></div>
                    <a href="#" id="show-update-notes" class="relative flex items-center px-3 py-2 text-neutral-800 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition duration-300">
                        <i class="fa-solid fa-note-sticky mr-2 w-4 text-center text-neutral-600 dark:text-neutral-300"></i> Update Notes
                    </a>
                </div>
            </header>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="w-full px-4 sm:px-8 pt-[62px] pb-[120px] flex-1 flex flex-col min-h-0 mx-auto max-w-2xl relative transition-colors duration-300">
        
        <div id="empty-chat-prompt" class="text-3xl select-none text-neutral-500 dark:text-neutral-400 font-light">
            How can I help you today?
        </div>
        
        <!-- FIX: The chat window (okemo-chat) is what needs the distinct background. -->
        <div id="okemo-chat" class="chat-scroll overflow-y-auto flex-1 relative transition-all duration-300">
            <!-- Chat messages injected here -->
        </div>
    </div>

    <!-- Fixed Input Bar -->
    <div class="fixed bottom-0 left-0 right-0 z-20 transition-colors duration-300 bg-white dark:bg-neutral-900">
        <div class="w-full max-w-2xl px-4 sm:px-8 mx-auto pb-4 pt-2">
            
            <div id="okemo-status" class="min-h-5 text-sm text-neutral-500 dark:text-neutral-400 mb-1 transition-all duration-300"></div>

            <div id="okemo-loading-bar" class="h-0.5 w-full overflow-hidden hidden rounded-full mb-2 transition-all duration-300">
                <div class="loading-line-animation h-full bg-neutral-900 dark:bg-white transition-all duration-300"></div>
            </div>
            
            <div id="input-bar-container" class="w-full bg-neutral-100 dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 relative transition-all duration-300">
                
                <!-- File Preview Container (Row 1) -->
                <div id="file-preview-container" class="hidden transition-all duration-300">
                    </div>
                
                <!-- Textarea (Row 2, Column 1) -->
                <textarea
                    id="okemo-input"
                    placeholder="Message OLM..." 
                    rows="1" 
                    class="rounded-xl focus:outline-none text-base text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-neutral-500 resize-none h-auto min-h-[48px] max-h-60 overflow-hidden bg-transparent transition-all duration-300 border-none focus:ring-0"
                ></textarea>
                
                <!-- Buttons Wrapper (Row 2, Column 2) -->
                <div id="s-wrapper" class="transition-all duration-300">
                    
                    <!-- Dropdown Menu for Plus Button -->
                    <div id="input-dropdown" class="absolute right-0 bottom-[calc(100%+10px)] w-48 bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl shadow-xl z-10 hidden p-1 transform opacity-0 scale-y-0 transition-all duration-200 ease-out origin-bottom-right">
                        
                        <button id="web-search-option" class="w-full relative flex items-center px-3 py-2 text-neutral-800 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition duration-300">
                            <i class="fa-solid fa-globe mr-2 w-4 text-center text-neutral-600 dark:text-neutral-300 transition-all duration-300"></i> Web Search
                        </button>

                        <button id="add-image-option" class="w-full relative flex items-center px-3 py-2 text-neutral-800 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition duration-300">
                            <i class="fa-solid fa-image mr-2 w-4 text-center text-neutral-600 dark:text-neutral-300 transition-all duration-300"></i> Upload Photo
                        </button>
                        
                        <button id="new-feature-option" class="w-full relative flex items-center px-3 py-2 text-neutral-800 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition duration-300">
                            <i class="fa-solid fa-paperclip mr-2 w-4 text-center text-neutral-600 dark:text-neutral-300 transition-all duration-300"></i> Attach File
                        </button>
                    </div>
                    
                    <!-- Plus Menu Toggle Button -->
                    <button
                        id="plus-menu-toggle"
                        class="cursor-pointer rounded-full text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white w-8 h-8 flex items-center justify-center transition duration-300 transform"
                        aria-label="Open Input Menu"
                    >
                        <i id="plus-icon" class="fa-solid fa-plus text-lg transition-all duration-300"></i>
                    </button>

                    <!-- Send Button -->
                    <button id="okemo-send"
                        class="cursor-pointer rounded-xl bg-neutral-900 dark:bg-white hover:bg-neutral-800 dark:hover:bg-neutral-100 active:bg-black dark:active:bg-neutral-300 text-white dark:text-black w-10 h-10 flex items-center justify-center transition duration-300"
                        aria-label="Send"
                    >
                        <i class="fa-solid fa-arrow-up text-sm transition-all duration-300"></i>
                    </button>
                </div>
            </div>
            
            <input type="file" id="file-upload-input" class="hidden" accept=".pdf,.doc,.docx,.txt">
            <input type="file" id="image-upload-input" class="hidden" accept="image/*">
            
        </div>
    </div>

    <!-- Theme Script -->
    <script>
      const htmlElement = document.documentElement;
      const themeKey = 'theme';

      function loadTheme() {
        const storedTheme = localStorage.getItem(themeKey);

        if (storedTheme === 'light') {
          htmlElement.classList.remove('dark');
        } else if (storedTheme === 'dark') {
          htmlElement.classList.add('dark');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            htmlElement.classList.add('dark');
        } else {
            htmlElement.classList.remove('dark');
        }
        
        document.dispatchEvent(new Event('themeLoaded'));
      }

      document.addEventListener('DOMContentLoaded', loadTheme);
    </script>
    
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

        const SPACE_ID = "ar12c/okemo2";
        let gradioClient = null;
        let history = [];
        const MAX_RETRIES = 3;
        let retryCount = 0;

        // Local storage keys
        const DISCLAIMER_KEY = "okemoDisclaimerAccepted";
        const NOTES_SEEN_KEY = "okemo-notes-v0.1.2-seen";

        // UI constraints
        const MAX_TEXTAREA_HEIGHT = 150;
        const MAX_CHARS = 500;

        // Global state for new features
        // NOTE: webSearchStatus now controls the local prepending of the <WEB> tag.
        let webSearchStatus = true; 
        let currentFile = null; Â  Â  Â 

        // Tooltip state
        let currentTooltip = null;
        let hideTimeout = null;

        // UI Elements (Global Declarations)
        let textarea;
        let disclaimerAgreeButton;
        let disclaimerCheckbox;
        let menuToggleButton;
        let newChatLink1;
        let newChatLink2;
        let updateNotesLink;
        let okemoSendButton;
        let updateNotesCloseBtn;
        let updateNotesCheckbox;

        let webSearchOption; 
        let filePreviewContainer;
        let fileUploadInput;
        let imageUploadInput;
        let addImageOption;
        let newFeatureOption;

        let dropdown;
        let disclaimerModal;
        let updateNotesModal;
        let menuIcon;
        let updateBadge;

        let emptyChatPrompt;
        let okemoChatBox;
        let newChatLinkHeader; // New element added in HTML rewrite

        // Regex to extract the temporary object URL and file names injected into the user message for preview
        const IMAGE_URL_REGEX = /\[IMAGE_PREVIEW_URL:(.*?)]/;
        const FILE_ATTACHMENT_REGEX = /\(Attached: (.*?)\)/;


        // =================================================================================
        // 1. INITIALIZATION & ELEMENT SELECTION
        // =================================================================================

        function initializeElements() {
        Â  textarea = document.getElementById("okemo-input");
        Â  disclaimerAgreeButton = document.getElementById("disclaimer-agree");
        Â  disclaimerCheckbox = document.getElementById("dont-show-again");
        Â  menuToggleButton = document.getElementById("menu-toggle");
        Â  okemoSendButton = document.getElementById("okemo-send");
        Â  updateNotesModal = document.getElementById("update-notes-modal");
        Â  updateNotesCloseBtn = document.getElementById("update-notes-close");
        Â  updateNotesCheckbox = document.getElementById('notes-dont-show-again');
        Â  updateBadge = document.getElementById("update-note-badge");
        Â  
        Â  if (updateBadge) {
        Â  Â  Â  updateBadge.style.transform = 'translateX(2px)';
        Â  }
        Â  
        Â  dropdown = document.getElementById("okemo-dropdown");
        Â  disclaimerModal = document.getElementById("disclaimer-modal");
        Â  okemoChatBox = document.getElementById("okemo-chat");
        Â  menuIcon = document.getElementById("menu-icon");
        Â  newChatLink1 = document.getElementById("new-chat-dropdown-1");
        Â  newChatLink2 = document.getElementById("new-chat-dropdown-2");
        Â  updateNotesLink = document.getElementById("show-update-notes");
        Â  emptyChatPrompt = document.getElementById("empty-chat-prompt");
            newChatLinkHeader = document.getElementById("new-chat-link-header");

        Â  // NEW FILE/WEB SEARCH ELEMENTS
        Â  webSearchOption = document.getElementById("web-search-option"); 
        Â  filePreviewContainer = document.getElementById("file-preview-container");
        Â  fileUploadInput = document.getElementById("file-upload-input");
        Â  imageUploadInput = document.getElementById("image-upload-input");
        Â  addImageOption = document.getElementById("add-image-option");
        Â  newFeatureOption = document.getElementById("new-feature-option");
        }

        async function initOkemo() {
        Â  try {
        Â  Â  if (typeof Client !== "undefined") {
        Â  Â  Â  // Ensure Client is loaded, then connect
        Â  Â  Â  gradioClient = await Client.connect(SPACE_ID);
        Â  Â  Â  retryCount = 0;
        Â  Â  Â  showStatus("Connected to OkemoLLM! âœ¨");
        Â  Â  Â  setTimeout(() => showStatus(""), 1500);
        Â  Â  }
        Â  } catch (err) {
        Â  Â  console.error("Failed to connect to OkemoLLM:", err);
        Â  Â  if (retryCount < MAX_RETRIES) {
        Â  Â  Â  retryCount += 1;
        Â  Â  Â  const delay = Math.min(2000 * Math.pow(2, retryCount - 1), 15000);
        Â  Â  Â  showStatus(`Failed to connect. Retrying in ${Math.round(delay / 1000)}sâ€¦`, true);
        Â  Â  Â  setTimeout(() => initOkemo(), delay);
        Â  Â  } else {
        Â  Â  Â  showStatus("Unable to connect to OkemoLLM after multiple attempts. ðŸ˜­", true);
        Â  Â  }
        Â  }
        }


        // =================================================================================
        // 2. UI UTILITIES (Tooltips, Status, Modals, Dropdowns)
        // =================================================================================

        function showTooltip(event) {
        Â  if (hideTimeout) {
        Â  Â  clearTimeout(hideTimeout);
        Â  Â  hideTimeout = null;
        Â  }
        Â  const button = event.currentTarget;
        Â  const content = button.getAttribute("data-tooltip-content");
        Â  if (!content) return;
        Â  if (currentTooltip && currentTooltip.parentNode) {
        Â  Â  currentTooltip.parentNode.removeChild(currentTooltip);
        Â  Â  currentTooltip = null;
        Â  }
        Â  const tooltip = document.createElement("div");
        Â  tooltip.id = "dynamic-tooltip";
        Â  tooltip.className = "fixed z-[9999] px-2 py-1 text-xs text-white bg-neutral-800 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none whitespace-nowrap";
        Â  tooltip.textContent = content;
        Â  document.body.appendChild(tooltip);
        Â  currentTooltip = tooltip;
        Â  const rect = button.getBoundingClientRect();
        Â  void tooltip.offsetWidth;
        Â  const tw = tooltip.offsetWidth;
        Â  const top = rect.bottom + 8;
        Â  const left = rect.left + rect.width / 2 - tw / 2;
        Â  tooltip.style.top = `${top}px`;
        Â  tooltip.style.left = `${left}px`;
        Â  setTimeout(() => {
        Â  Â  tooltip.classList.remove("opacity-0");
        Â  Â  tooltip.classList.add("opacity-100");
        Â  }, 10);
        }

        function hideTooltip(duration = 300) {
        Â  if (hideTimeout) clearTimeout(hideTimeout);
        Â  if (!currentTooltip) return;
        Â  currentTooltip.classList.remove("opacity-100");
        Â  currentTooltip.classList.add("opacity-0");
        Â  hideTimeout = setTimeout(() => {
        Â  Â  if (currentTooltip && document.body.contains(currentTooltip)) {
        Â  Â  Â  document.body.removeChild(currentTooltip);
        Â  Â  }
        Â  Â  currentTooltip = null;
        Â  Â  hideTimeout = null;
        Â  }, duration);
        }

        function updateEmptyChatPromptVisibility() {
        Â  if (!emptyChatPrompt) return;
        Â  if (history.length === 0) {
        Â  Â  emptyChatPrompt.classList.remove("hidden");
        Â  Â  emptyChatPrompt.style.opacity = "1";
        Â  } else {
        Â  Â  emptyChatPrompt.style.opacity = "0";
        Â  Â  setTimeout(() => {
        Â  Â  Â  emptyChatPrompt.classList.add("hidden");
        Â  Â  }, 300);
        Â  }
        }

        function showStatus(msg, isError = false, targetElementId = "okemo-status") {
        Â  const el = document.getElementById(targetElementId);
        Â  if (!el) return;
        Â  const errorColorClass = "text-red-500";
        Â  const statusColorClass = "text-neutral-500 dark:text-neutral-400";
        Â  el.textContent = msg;
        Â  el.className = `min-h-5 text-sm ${isError ? errorColorClass : statusColorClass} mb-1`;
        }

        function checkDisclaimerStatus() {
        Â  const accepted = localStorage.getItem(DISCLAIMER_KEY);
        Â  if (!disclaimerModal) return;
        Â  if (accepted !== "true") {
        Â  Â  disclaimerModal.classList.remove("hidden", "opacity-0");
        Â  }
        }

        function acceptDisclaimer() {
        Â  if (disclaimerCheckbox && disclaimerCheckbox.checked) {
        Â  Â  localStorage.setItem(DISCLAIMER_KEY, "true");
        Â  }
        Â  if (disclaimerModal) {
        Â  Â  disclaimerModal.classList.add("opacity-0");
        Â  Â  setTimeout(() => disclaimerModal.classList.add("hidden"), 300);
        Â  }
        Â  checkUpdateNotesStatus();
        }

        function checkUpdateNotesStatus() {
        Â  const seen = localStorage.getItem(NOTES_SEEN_KEY);
        Â  if (!updateNotesModal) return;
        Â  const disclaimerHidden = !disclaimerModal || disclaimerModal.classList.contains("hidden") || disclaimerModal.style.display === "none";
        Â  if (seen !== "true") {
        Â  Â  if (updateBadge) updateBadge.classList.remove("hidden");
        Â  Â  if (disclaimerHidden) {
        Â  Â  Â  showUpdateNotes();
        Â  Â  }
        Â  } else {
        Â  Â  if (updateBadge) updateBadge.classList.add("hidden");
        Â  }
        }

        function showUpdateNotes() {
        Â  if (updateNotesModal) {
        Â  Â  updateNotesModal.classList.remove("hidden");
        Â  Â  setTimeout(() => {
        Â  Â  Â  updateNotesModal.classList.remove("opacity-0");
        Â  Â  Â  updateNotesModal.classList.add("opacity-100");
        Â  Â  }, 10);
        Â  }
        Â  if (updateBadge) updateBadge.classList.add("hidden");
        }

        function closeUpdateNotes() {
        Â  if (updateNotesCheckbox && updateNotesCheckbox.checked) {
        Â  Â  Â  localStorage.setItem(NOTES_SEEN_KEY, 'true');
        Â  } else {
        Â  Â  Â  if (updateBadge) updateBadge.classList.remove("hidden");
        Â  }

        Â  if (updateNotesModal) updateNotesModal.classList.add("hidden");
        }

        function toggleDropdown() {
        Â  if (!dropdown) return;
        Â  if (dropdown.classList.contains("hidden")) {
        Â  Â  dropdown.classList.remove("hidden");
        Â  Â  if (menuToggleButton) menuToggleButton.classList.add("active");
        Â  Â  if (menuIcon) menuIcon.classList.remove("rotate-180");
        Â  Â  void dropdown.offsetWidth;
        Â  Â  dropdown.classList.remove("opacity-0", "scale-y-0");
        Â  Â  dropdown.classList.add("opacity-100", "scale-y-100");
        Â  } else {
        Â  Â  closeDropdown();
        Â  }
        }

        function closeDropdown() {
        Â  if (!dropdown || dropdown.classList.contains("hidden")) return;
        Â  if (menuToggleButton) menuToggleButton.classList.remove("active");
        Â  if (menuIcon) menuIcon.classList.remove("rotate-180");
        Â  dropdown.classList.remove("opacity-100", "scale-y-100");
        Â  dropdown.classList.add("opacity-0", "scale-y-0");
        Â  setTimeout(() => {
        Â  Â  dropdown.classList.add("hidden");
        Â  }, 300);
        }

        function newChat(e) {
        Â  if (e) e.preventDefault();
        Â  history = [];
        Â  renderChat();
        Â  closeDropdown();
        Â  clearFileAttachment(); 
        Â  updateWebSearchUI(true, false); 
        Â  showStatus("New chat started.");
        Â  if (textarea) textarea.focus();
        Â  updateEmptyChatPromptVisibility();
        }


        // =================================================================================
        // 3. FILE AND WEB SEARCH UTILITIES
        // =================================================================================

        function updateWebSearchUI(isEnabled, showStatusMsg = false) {
        Â  Â  webSearchStatus = isEnabled;
        Â  Â  if (!webSearchOption) return;
        Â  Â  
        Â  Â  const icon = webSearchOption.querySelector("i");
        Â  Â  
        Â  Â  // Update background and text color to indicate selected state (Monochrome tint)
        Â  Â  webSearchOption.classList.toggle("bg-neutral-200", isEnabled);
        Â  Â  webSearchOption.classList.toggle("dark:bg-neutral-700", isEnabled);
        Â  Â  
        Â  Â  // Ensure icon color is visible
        Â  Â  icon.classList.toggle("text-neutral-700", isEnabled);
        Â  Â  icon.classList.toggle("dark:text-neutral-300", isEnabled);

        Â  Â  if (showStatusMsg) {
                // Update status message to reflect backend control
        Â  Â  Â  Â  showStatus(isEnabled ? "Web search enabled. Next message will include '<WEB>'." : "Web search disabled. Search tag will be omitted.");
        Â  Â  }
        }


        /**
        Â * Renders the file attachment preview or clears it. Displays image thumbnail if applicable.
        Â */
        function renderFilePreview(file) {
        Â  Â  currentFile = file;
        Â  Â  if (!filePreviewContainer) return;

        Â  Â  // Revoke previous object URL to prevent memory leaks
        Â  Â  if (filePreviewContainer.dataset.objectUrl) {
        Â  Â  Â  Â  URL.revokeObjectURL(filePreviewContainer.dataset.objectUrl);
        Â  Â  Â  Â  filePreviewContainer.removeAttribute('data-object-url');
        Â  Â  }

        Â  Â  if (file) {
        Â  Â  Â  Â  let isImage = file.type.startsWith("image");
        Â  Â  Â  Â  let objectUrl = URL.createObjectURL(file);
        Â  Â  Â  Â  filePreviewContainer.dataset.objectUrl = objectUrl; // Store URL for later revocation

        Â  Â  Â  Â  let previewHtml;

        Â  Â  Â  Â  if (isImage) {
        Â  Â  Â  Â  Â  Â  const fileName = file.name;
        Â  Â  Â  Â  Â  Â  // Modernized image preview
        Â  Â  Â  Â  Â  Â  previewHtml = `
        Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative w-24 h-24 mt-4 mb-2 rounded-xl overflow-hidden border border-neutral-300 dark:border-neutral-600">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${objectUrl}" alt="Attached image preview" class="w-full h-full object-cover"/>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="remove-file-button"
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="absolute top-1 right-1 bg-neutral-900/70 hover:bg-neutral-900 text-white w-6 h-6 flex items-center justify-center rounded-full shadow-md transition duration-300 z-10"
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aria-label="Remove attached image: ${fileName}">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-xmark text-xs"></i>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
        Â  Â  Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  Â  `;
        Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  let iconClass = "fa-file";
        Â  Â  Â  Â  Â  Â  if (file.name.endsWith(".pdf")) iconClass = "fa-file-pdf";
        Â  Â  Â  Â  Â  Â  else if (file.name.endsWith(".doc") || file.name.endsWith(".docx")) iconClass = "fa-file-word";
        Â  Â  Â  Â  Â  Â  else if (file.name.endsWith(".txt")) iconClass = "fa-file-lines";
        Â  Â  Â  Â  Â  Â  
        Â  Â  Â  Â  Â  Â  const iconHtml = `<i class="fa-solid ${iconClass} mr-2 text-base text-neutral-500 dark:text-neutral-400"></i>`;
        Â  Â  Â  Â  Â  Â  const fileName = file.name;

        Â  Â  Â  Â  Â  Â  // Modernized file preview
        Â  Â  Â  Â  Â  Â  previewHtml = `
        Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between p-2 mt-2 mb-2 bg-neutral-200 dark:bg-neutral-700 text-neutral-800 dark:text-neutral-200 text-sm font-medium rounded-lg">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center truncate max-w-[85%]">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${iconHtml}
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="truncate">${fileName}</span>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="remove-file-button" class="text-neutral-500 hover:text-red-500 p-1 rounded-full transition duration-300" aria-label="Remove attached file">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-xmark text-lg"></i>
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
        Â  Â  Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  Â  `;
        Â  Â  Â  Â  }

        Â  Â  Â  Â  filePreviewContainer.innerHTML = previewHtml;
        Â  Â  Â  Â  filePreviewContainer.classList.remove("hidden");

        Â  Â  Â  Â  if (okemoChatBox) okemoChatBox.scrollTop = okemoChatBox.scrollHeight;

        Â  Â  Â  Â  document.getElementById("remove-file-button").addEventListener('click', clearFileAttachment);

        Â  Â  } else {
        Â  Â  Â  Â  filePreviewContainer.classList.add("hidden");
        Â  Â  Â  Â  filePreviewContainer.innerHTML = "";
        Â  Â  }
        }

        function clearFileAttachment() {
        Â  Â  // Revoke object URL before clearing preview if one exists
        Â  Â  if (filePreviewContainer && filePreviewContainer.dataset.objectUrl) {
        Â  Â  Â  Â  URL.revokeObjectURL(filePreviewContainer.dataset.objectUrl);
        Â  Â  }
        Â  Â  renderFilePreview(null);
        Â  Â  if (fileUploadInput) fileUploadInput.value = "";
        Â  Â  if (imageUploadInput) imageUploadInput.value = "";
        Â  Â  
        Â  Â  if(textarea) textarea.dispatchEvent(new Event('input'));
        }


        // =================================================================================
        // 4. CHAT RENDERING AND TOOLBOX
        // =================================================================================

        function escapeHTML(s) {
        Â  return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function createButtonContainerHTML(isLastResponse, turnId) {
        Â  // Style for icons: dark gray on light, light gray on dark
        Â  const lightIconColor = "color: #4b5563;"; // neutral-600
        Â  const darkIconColor = "color: #9ca3af;"; Â // neutral-400
        Â  const iconStyleAttributes = `data-light-style="${lightIconColor}" data-dark-style="${darkIconColor}"`; 
        Â  const hoverBg = "hover:bg-neutral-200 dark:hover:bg-neutral-700";
        Â  
        Â  // Feedback buttons are only shown on the last response
        Â  const feedbackButtons = isLastResponse
        Â  Â  ? `
        Â  Â  Â  Â  <button id="good-response-feedback-${turnId}" class="text-sm font-medium p-1 rounded-full transition duration-300 ${hoverBg}" data-tooltip-content="Good Response">
        Â  Â  Â  Â  Â  <i class="fa-regular fa-thumbs-up text-sm" ${iconStyleAttributes}></i>
        Â  Â  Â  Â  </button>
        Â  Â  Â  Â  <button id="bad-response-feedback-${turnId}" class="text-sm font-medium p-1 rounded-full transition duration-300 ${hoverBg}" data-tooltip-content="Bad Response">
        Â  Â  Â  Â  Â  <i class="fa-regular fa-thumbs-down text-sm" ${iconStyleAttributes}></i>
        Â  Â  Â  Â  </button>
        Â  Â  Â  `
        Â  Â  : "";
            
        Â  const visibilityClass = isLastResponse ? "opacity-100 pointer-events-auto always-visible" : "opacity-0 pointer-events-none";
        Â  
        Â  // Combined Toolbox (Copy, Export, Regenerate, Feedback)
        Â  return `
        Â  Â  <div class="flex items-center transition-opacity duration-300 chat-toolbox ${visibilityClass} gap-1" id="regenerate-container-${turnId}">
                ${feedbackButtons}
        Â  Â  Â  Â  <button id="copy-button-${turnId}" class="text-sm font-medium p-1 rounded-full transition duration-300 ${hoverBg}" data-tooltip-content="Copy">
        Â  Â  Â  Â  Â  <i class="fa-regular fa-copy text-sm" ${iconStyleAttributes}></i>
        Â  Â  Â  Â  </button>
        Â  Â  Â  Â  <button id="export-chat-button-${turnId}" class="text-sm font-medium p-1 rounded-full transition duration-300 ${hoverBg}" data-tooltip-content="Export as .txt">
        Â  Â  Â  Â  Â  <i class="fa-solid fa-file-export text-sm" ${iconStyleAttributes}></i>
        Â  Â  Â  Â  </button>
        Â  Â  Â  Â  <button id="regenerate-button-${turnId}" class="text-sm font-medium p-1 rounded-full transition duration-300 ${hoverBg}" data-tooltip-content="Regenerate">
        Â  Â  Â  Â  Â  <i class="fas fa-redo-alt text-sm" ${iconStyleAttributes}></i>
        Â  Â  Â  Â  </button>
        Â  Â  </div>
        Â  `;
        }

        function attachToolboxListeners(wrapperEl, index) {
        Â  const turnId = index;
        Â  const toolbox = wrapperEl.querySelector(`#regenerate-container-${turnId}`);
        Â  const isLastTurn = index === history.length - 1;
        Â  if (!toolbox) return;
        Â  
        Â  const updateIconColors = () => {
        Â  Â  const isDarkMode = document.documentElement.classList.contains("dark");
        Â  Â  toolbox.querySelectorAll("i").forEach((icon) => {
        Â  Â  Â  const darkStyle = icon.getAttribute("data-dark-style");
        Â  Â  Â  const lightStyle = icon.getAttribute("data-light-style");
        Â  Â  Â  
        Â  Â  Â  if (isDarkMode && darkStyle) {
        Â  Â  Â  Â  icon.setAttribute("style", darkStyle);
        Â  Â  Â  } else if (lightStyle) {
        Â  Â  Â  Â  icon.setAttribute("style", lightStyle);
        Â  Â  Â  }
        Â  Â  });
        Â  };
        Â  
        Â  updateIconColors();
        Â  document.removeEventListener('themeLoaded', updateIconColors);
        Â  document.addEventListener('themeLoaded', updateIconColors);

        Â  if (!isLastTurn) {
        Â  Â  wrapperEl.addEventListener("mouseover", () => {
        Â  Â  Â  toolbox.classList.remove("opacity-0", "pointer-events-none");
        Â  Â  Â  toolbox.classList.add("opacity-100", "pointer-events-auto");
        Â  Â  });
        Â  Â  wrapperEl.addEventListener("mouseout", () => {
        Â  Â  Â  toolbox.classList.remove("opacity-100", "pointer-events-auto");
        Â  Â  Â  toolbox.classList.add("opacity-0", "pointer-events-none");
        Â  Â  Â  hideTooltip();
        Â  Â  });
        Â  }
        Â  
        Â  const copyButton = toolbox.querySelector(`#copy-button-${turnId}`);
        Â  const exportChatButton = toolbox.querySelector(`#export-chat-button-${turnId}`);
        Â  const regenerateButton = toolbox.querySelector(`#regenerate-button-${turnId}`);
        Â  const goodFeedbackButton = toolbox.querySelector(`#good-response-feedback-${turnId}`);
        Â  const badFeedbackButton = toolbox.querySelector(`#bad-response-feedback-${turnId}`);
        Â  
        Â  // Add listeners for all buttons
        Â  const buttons = [copyButton, exportChatButton, regenerateButton, goodFeedbackButton, badFeedbackButton];
        Â  buttons.forEach(button => {
                if (button) {
                    button.addEventListener("mouseover", showTooltip);
                    button.addEventListener("mouseout", () => hideTooltip());
                }
            });

        Â  if (copyButton) {
        Â  Â  copyButton.addEventListener("click", (e) => {
        Â  Â  Â  e.preventDefault();
        Â  Â  Â  copyResponseByTurnIndex(copyButton, index); 
        Â  Â  });
        Â  }
        Â  if (exportChatButton) {
        Â  Â  exportChatButton.addEventListener("click", (e) => {
        Â  Â  Â  e.preventDefault();
        Â  Â  Â  exportChatHistory(exportChatButton);
        Â  Â  });
        Â  }
        Â  if (regenerateButton) {
        Â  Â  if (isLastTurn) {
        Â  Â  Â  regenerateButton.addEventListener("click", (e) => {
        Â  Â  Â  Â  e.preventDefault();
        Â  Â  Â  Â  sendOkemoMessage(false, e.currentTarget); 
        Â  Â  Â  });
        Â  Â  } else {
        Â  Â  Â  regenerateButton.style.opacity = "0.5";
        Â  Â  Â  regenerateButton.style.cursor = "not-allowed";
        Â  Â  Â  regenerateButton.setAttribute("data-tooltip-content", "Regeneration only available for the latest turn.");
        Â  Â  }
        Â  }
        Â  if (goodFeedbackButton) {
        Â  Â  goodFeedbackButton.addEventListener("click", (e) => {
        Â  Â  Â  e.preventDefault();
        Â  Â  Â  sendFeedback("Good Response", true, goodFeedbackButton, badFeedbackButton); 
        Â  Â  });
        Â  }
        Â  
        Â  if (badFeedbackButton) {
        Â  Â  if (!isLastTurn) {
        Â  Â  Â  Â  badFeedbackButton.addEventListener("click", (e) => {
        Â  Â  Â  Â  Â  Â  Â e.preventDefault();
        Â  Â  Â  Â  Â  Â  Â sendFeedback("Bad Response", false, goodFeedbackButton, badFeedbackButton); 
        Â  Â  Â  Â  });
        Â  Â  }
        Â  Â  setupBadFeedbackPopup(badFeedbackButton); 
        Â  }
        }

        // Function that handles the Bad Response feedback modal
        function setupBadFeedbackPopup(badFeedbackButton) {
        Â  if (!badFeedbackButton) return;
        Â  
        Â  badFeedbackButton.removeEventListener("click", badFeedbackButton.clickHandler);

        Â  const clickHandler = (e) => {
        Â  Â  e.preventDefault();
            
            // Only show modal for the last turn
            const isLastTurn = badFeedbackButton.id.includes(`bad-response-feedback-${history.length - 1}`);

            if (!isLastTurn) {
                sendFeedback("Bad Response", false, null, null);
                return;
            }

        Â  Â  const modal = document.getElementById("bad-feedback-modal");
        Â  Â  const textarea = document.getElementById("bad-feedback-input");
        Â  Â  
        Â  Â  if (!modal || !textarea) {
        Â  Â  Â  sendFeedback("Bad Response", false, null, null);
        Â  Â  Â  return;
        Â  Â  }

        Â  Â  textarea.value = "";
        Â  Â  modal.classList.remove("hidden");
        Â  Â  setTimeout(() => modal.classList.remove("opacity-0"), 10);
        Â  Â  textarea.focus();

        Â  Â  const submitBtn = document.getElementById("submit-bad-feedback");
        Â  Â  const cancelBtn = document.getElementById("cancel-bad-feedback");

        Â  Â  const oldSubmitHandler = submitBtn.clickHandler;
        Â  Â  const oldCancelHandler = cancelBtn.clickHandler;
        Â  Â  if (oldSubmitHandler) submitBtn.removeEventListener("click", oldSubmitHandler);
        Â  Â  if (oldCancelHandler) cancelBtn.removeEventListener("click", oldCancelHandler);

        Â  Â  const closeModal = () => {
        Â  Â  Â  modal.classList.add("opacity-0");
        Â  Â  Â  setTimeout(() => modal.classList.add("hidden"), 300);
        Â  Â  };

        Â  Â  const handleSubmit = async () => {
        Â  Â  Â  const newPrompt = textarea.value.trim();
        Â  Â  Â  if (!newPrompt) {
        Â  Â  Â  Â  console.error("Please enter a suggested prompt before submitting.");
        Â  Â  Â  Â  showStatus("Please enter a suggested prompt before submitting.", true);
        Â  Â  Â  Â  return;
        Â  Â  Â  }
        Â  Â  Â  
        Â  Â  Â  badFeedbackButton.disabled = true;
        Â  Â  Â  const goodBtn = document.getElementById(`good-response-feedback-${history.length - 1}`);
        Â  Â  Â  if (goodBtn) goodBtn.disabled = true;

        Â  Â  Â  closeModal();
        Â  Â  Â  showStatus("Submitting detailed feedback...");

        Â  Â  Â  try {
        Â  Â  Â  Â  if (!gradioClient) await initOkemo();
        Â  Â  Â  Â  const inputs = [history, newPrompt];
        Â  Â  Â  Â  const result = await gradioClient.predict("/feedback_bad_with_prompt", inputs); 
        Â  Â  Â  Â  const feedbackMessage = result?.data?.[1] || "Feedback received. Thank thank you!";
        Â  Â  Â  Â  showStatus(feedbackMessage);
        Â  Â  Â  } catch (err) {
        Â  Â  Â  Â  console.error("Error sending feedback prompt:", err);
        Â  Â  Â  Â  showStatus("Failed to send feedback. Check console.", true);
        Â  Â  Â  } finally {
        Â  Â  Â  Â  badFeedbackButton.disabled = false;
        Â  Â  Â  Â  if (goodBtn) goodBtn.disabled = false;
        Â  Â  Â  Â  setTimeout(() => showStatus(""), 1500); 
        Â  Â  Â  }
        Â  Â  };

        Â  Â  const handleCancel = () => {
        Â  Â  Â  closeModal();
        Â  Â  Â  sendFeedback("Bad Response", false, null, null); 
        Â  Â  };
        Â  Â  
        Â  Â  submitBtn.clickHandler = handleSubmit;
        Â  Â  cancelBtn.clickHandler = handleCancel;
        Â  Â  submitBtn.addEventListener("click", handleSubmit);
        Â  Â  cancelBtn.addEventListener("click", handleCancel);
        Â  };
        Â  
        Â  badFeedbackButton.clickHandler = clickHandler;
        Â  badFeedbackButton.addEventListener("click", clickHandler);
        }

        function renderChat() {
        Â  const box = okemoChatBox;
        Â  if (!box) return;
        Â  box.innerHTML = "";
        Â  const htmlContent = [];
        Â  
        Â  for (let i = 0; i < history.length; i++) {
        Â  Â  const [u, a] = history[i];
        Â  Â  const isLastTurn = i === history.length - 1;
        Â  Â  const wrapperId = `chat-turn-${i}`;
            
        Â  Â  // User Message Block (Always appears in a row with a background)
        Â  Â  if (u) {
        Â  Â  Â  Â  const imageUrlMatch = u.match(IMAGE_URL_REGEX);
        Â  Â  Â  Â  const attachmentMatch = u.match(FILE_ATTACHMENT_REGEX);
        Â  Â  Â  Â  
        Â  Â  Â  Â  let userDisplayContent = escapeHTML(u);
        Â  Â  Â  Â  let mediaHtml = '';
        Â  Â  Â  Â  
        Â  Â  Â  Â  if (imageUrlMatch) {
        Â  Â  Â  Â  Â  Â  const imageUrl = imageUrlMatch[1];
        Â  Â  Â  Â  Â  Â  userDisplayContent = userDisplayContent.replace(escapeHTML(imageUrlMatch[0]), '').trim();
        Â  Â  Â  Â  Â  Â  
        Â  Â  Â  Â  Â  Â  mediaHtml = `
        Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2">
        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${imageUrl}" class="max-w-full h-auto rounded-lg" style="max-height: 250px; object-fit: cover;" alt="Attached Image"/>
        Â  Â  Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  Â  `;
        Â  Â  Â  Â  } else if (attachmentMatch) {
        Â  Â  Â  Â  Â  Â  userDisplayContent = userDisplayContent.replace(escapeHTML(attachmentMatch[0]), '').trim();
        Â  Â  Â  Â  Â  Â  mediaHtml = `<div class="mt-2 text-sm opacity-80">${escapeHTML(attachmentMatch[0])}</div>`;
        Â  Â  Â  Â  }

        Â  Â  Â  Â  const textHtml = userDisplayContent ? `<div>${userDisplayContent}</div>` : '';
            
        Â  Â  Â  Â  htmlContent.push(`
        Â  Â  Â  Â  Â  <div class="user-message-row w-full flex justify-end px-4 sm:px-8">
        Â  Â  Â  Â  Â  Â  <!-- User Message Bubble (Colors applied via CSS classes) -->
        Â  Â  Â  Â  Â  Â  <div class="inline-block max-w-[85%] rounded-2xl px-4 py-2 transform transition duration-300 ease-out">
        Â  Â  Â  Â  Â  Â  Â  ${textHtml}
        Â  Â  Â  Â  Â  Â  Â  ${mediaHtml}
        Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  </div>`);
        Â  Â  }
        Â  Â  
        Â  Â  // AI Message Block
        Â  Â  if (a) {
        Â  Â  Â  Â  htmlContent.push(`<div id="${wrapperId}" class="chat-turn-wrapper">`);
        Â  Â  Â  Â  // AI message row structure
        Â  Â  Â  Â  htmlContent.push(`
        Â  Â  Â  Â  Â  <div class="ai-message-row flex items-start gap-3 px-4 sm:px-8">
        Â  Â  Â  Â  Â  Â  <div class="ai-logo-placeholder">O</div>
        Â  Â  Â  Â  Â  Â  <div class="max-w-[85%] pt-1 text-base text-neutral-900 dark:text-neutral-200" style="white-space: pre-wrap;">
        Â  Â  Â  Â  Â  Â  Â  ${escapeHTML(a)}
        Â  Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  </div>
        Â  Â  Â  Â  Â  <div class="mb-4 flex justify-start pl-[52px] relative chat-turn-buttons">
        Â  Â  Â  Â  Â  Â  ${createButtonContainerHTML(isLastTurn, i)}
        Â  Â  Â  Â  Â  </div>
                </div>`);
        Â  Â  } else if (u) {
                // If it's a user message without an AI response, we still need the wrapper for the toolbox in the next step
                htmlContent.push(`<div id="${wrapperId}" class="chat-turn-wrapper"></div>`);
            }
        Â  }
            
        Â  box.innerHTML = htmlContent.join("");
        Â  
        Â  // Re-attach listeners for all turns
        Â  for (let i = 0; i < history.length; i++) {
        Â  Â  const turnWrapper = document.getElementById(`chat-turn-${i}`);
        Â  Â  if (turnWrapper) attachToolboxListeners(turnWrapper, i);
        Â  }
        Â  
        Â  updateEmptyChatPromptVisibility();
        Â  box.scrollTop = box.scrollHeight;
        Â  
        Â  // Re-attach the special logic for the last turn's bad feedback button after re-rendering
        Â  if (history.length > 0) {
        Â  Â  Â  const lastTurnId = history.length - 1;
        Â  Â  Â  const lastTurnWrapper = document.getElementById(`chat-turn-${lastTurnId}`);
        Â  Â  Â  if (lastTurnWrapper) {
        Â  Â  Â  Â  Â  const badFeedbackButton = lastTurnWrapper.querySelector(`#bad-response-feedback-${lastTurnId}`);
        Â  Â  Â  Â  Â  setupBadFeedbackPopup(badFeedbackButton); 
        Â  Â  Â  }
        Â  }
        }

        // =================================================================================
        // 5. API INTERACTION (Send Message and Feedback)
        // =================================================================================

        async function sendFeedback(rating, triggerLearning, goodBtn, badBtn) {
        Â  if (history.length === 0) {
        Â  Â  showStatus("No message to rate. Start a conversation first! ðŸ¤·â€â™€ï¸", true);
        Â  Â  return;
        Â  }
        Â  
        Â  if (goodBtn) goodBtn.disabled = true;
        Â  if (badBtn) badBtn.disabled = true;
        Â  
        Â  const loadingBar = document.getElementById("okemo-loading-bar");
        Â  if (loadingBar) loadingBar.classList.remove("hidden");
        Â  showStatus(`Sending feedback: ${rating}...`);

        Â  try {
        Â  Â  if (!gradioClient) await initOkemo();
        Â  Â  if (!gradioClient) throw new Error("No connection to OkemoLLM.");

        Â  Â  const endpoint = triggerLearning ? "/feedback_good" : "/feedback_bad";
        Â  Â  const inputs = [history]; 
        Â  Â  
        Â  Â  const result = await gradioClient.predict(endpoint, inputs);
        Â  Â  
        Â  Â  const updatedHistoryFromServer = result?.data?.[0];
        Â  Â  if (Array.isArray(updatedHistoryFromServer)) {
        Â  Â  Â  Â  history = updatedHistoryFromServer;
        Â  Â  }
        Â  Â  
        Â  Â  const feedbackMessage = result?.data?.[1] || `${rating} logged successfully.`;
        Â  Â  showStatus(feedbackMessage);
        Â  Â  renderChat();
        Â  Â  
        Â  } catch (err) {
        Â  Â  console.error("Feedback submission error:", err);
        Â  Â  showStatus(`Error submitting feedback. Please check the console.`, true);
        Â  } finally {
        Â  Â  if (loadingBar) loadingBar.classList.add("hidden");
        Â  Â  setTimeout(() => showStatus(""), 1500);
        Â  }
        }


        async function sendOkemoMessage(isPlusMenuAction = false, element = null) {
        Â  const inputEl = textarea;
        Â  const btnEl = okemoSendButton;
        Â  const loadingBar = document.getElementById("okemo-loading-bar");
        Â  
        Â  if (!inputEl || !btnEl || !loadingBar) return;

        Â  let userMsg = inputEl.value.trim();
        Â  const isRegenerate = element && element.id.includes("regenerate-button");
        Â  const isStandardSend = !isRegenerate;
        Â  
        Â  if (isStandardSend && userMsg.length > MAX_CHARS) {
        Â  Â  showStatus(`Message exceeds maximum limit of ${MAX_CHARS} characters.`, true);
        Â  Â  return;
        Â  }
        Â  if (isStandardSend && !userMsg && !currentFile) {
        Â  Â  showStatus(`Please enter a message or attach a file.`, true);
        Â  Â  return;
        Â  }

        Â  let messageToSendToAPI;
        Â  let cleanUserMessageForHistory;
        Â  
        Â  let imageMarker = ''; 
          // New variable for web search tag
          const webSearchTag = webSearchStatus ? "<WEB>" : ""; 


        Â  // --- 1. Determine Prompt and History state ---
        Â  if (isRegenerate) {
        Â  Â  Â  if (history.length === 0) {
        Â  Â  Â  Â  Â  showStatus("Please type a message before requesting regeneration.", true);
        Â  Â  Â  Â  Â  return;
        Â  Â  Â  }
        Â  Â  Â  const lastUserMessage = history[history.length - 1][0]; 
        Â  Â  Â  if (!lastUserMessage) {
        Â  Â  Â  Â  Â  showStatus("Cannot regenerate: last user message was empty.", true);
        Â  Â  Â  Â  Â  return;
        Â  Â  Â  }
        Â  Â  Â  
        Â  Â  Â  const existingMatch = lastUserMessage.match(IMAGE_URL_REGEX);
        Â  Â  Â  if (existingMatch) {
        Â  Â  Â  Â  Â  imageMarker = existingMatch[0];
        Â  Â  Â  }
        Â  Â  Â  
        Â  Â  Â  history.pop();
        Â  Â  Â  
        Â  Â  Â  cleanUserMessageForHistory = lastUserMessage.replace(IMAGE_URL_REGEX, '').replace(FILE_ATTACHMENT_REGEX, '').trim();
        Â  Â  Â  // FIX: Ensure webSearchTag is correctly prepended to the final message. 
              // The backend requires the tag to be present in the message text.
              messageToSendToAPI = `${webSearchTag} Please generate a completely new and distinct response for the following: "${cleanUserMessageForHistory}"`.trim();
        Â  } else {
        Â  Â  Â  // Standard send
              // FIX: Ensure webSearchTag is correctly prepended to the final message.
        Â  Â  Â  messageToSendToAPI = `${webSearchTag} ${userMsg}`.trim();
        Â  Â  Â  cleanUserMessageForHistory = userMsg;
        Â  }
        Â  
        Â  // --- 2. Grab current state for Gradio API ---
        Â  // webSearchStatus is now used only for prepending the tag, not as a separate API input

        Â  // --- 3. Disable UI and Show Loading ---
        Â  const toolbox = document.querySelector(".chat-toolbox.always-visible");
        Â  if (toolbox) {
        Â  Â  Â  toolbox.querySelectorAll("button").forEach((b) => (b.disabled = true));
        Â  }
        Â  btnEl.disabled = true;
        Â  btnEl.classList.add("opacity-50", "cursor-not-allowed");
        Â  // Remove enabled button colors when disabled
        Â  btnEl.classList.remove("bg-neutral-900", "dark:bg-white", "hover:bg-neutral-800", "dark:hover:bg-neutral-100");
        Â  loadingBar.classList.remove("hidden"); 
        Â  showStatus("OLM Thinking...");

        Â  const historyToSend = [...history]; 

        Â  // **OPTIMISTIC UPDATE:** Display the user message immediately.
        Â  if (isStandardSend || isRegenerate) {
              // The history message should include the user's text, any file markers, and the web search tag.
        Â  Â  Â  let historyMessage = cleanUserMessageForHistory;
              
              // Only prepend the webSearchTag to the displayed history message if it was actually included in the API call, 
              // and if the user didn't already include it manually in their prompt.
              const isTagAlreadyInUserMsg = cleanUserMessageForHistory.toUpperCase().includes("<WEB>");
              if (webSearchTag && !isTagAlreadyInUserMsg) {
                  historyMessage = `${webSearchTag} ${historyMessage}`;
              }

        Â  Â  Â  if (currentFile) {
        Â  Â  Â  Â  Â  if (currentFile.type.startsWith("image")) {
        Â  Â  Â  Â  Â  Â  Â  imageMarker = ` [IMAGE_PREVIEW_URL:${filePreviewContainer.dataset.objectUrl}]`;
        Â  Â  Â  Â  Â  Â  Â  historyMessage += imageMarker;
        Â  Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  Â  historyMessage += ` (Attached: ${currentFile.name})`;
        Â  Â  Â  Â  Â  }
        Â  Â  Â  } else if (isRegenerate && imageMarker) {
        Â  Â  Â  Â  Â  historyMessage += imageMarker; 
        Â  Â  Â  }
        Â  Â  Â  history.push([historyMessage.trim(), null]); // Trim whitespace from history message
        Â  }
        Â  renderChat(); 

        Â  try {
        Â  Â  Â  if (!gradioClient) {
        Â  Â  Â  Â  Â  showStatus("Connecting to OkemoLLMâ€¦", true);
        Â  Â  Â  Â  Â  await initOkemo();
        Â  Â  Â  Â  Â  if (!gradioClient) throw new Error("Failed to connect to OkemoLLM.");
        Â  Â  Â  }

        Â  Â  Â  if (isStandardSend) {
        Â  Â  Â  Â  Â  inputEl.value = "";
        Â  Â  Â  Â  Â  inputEl.style.height = "48px";
        Â  Â  Â  }

        Â  Â  Â  // CRITICAL: Align inputs to the Gradio API /on_submit (4 inputs: message, history, file, web_enabled_flag_unused)
        Â  Â  Â  const inputs = [
        Â  Â  Â  Â  Â  messageToSendToAPI, 
        Â  Â  Â  Â  Â  historyToSend, Â  Â  Â 
        Â  Â  Â  Â  Â  currentFile
        Â  Â  Â  ];
        Â  Â  Â  
        Â  Â  Â  // Placeholder for the ignored fourth argument (web_search_enabled_flag_unused)
              inputs.push(true);
              
        Â  Â  Â  const result = await gradioClient.predict("/on_submit", inputs);
        Â  Â  Â  
        Â  Â  Â  let updatedHistoryFromServer = result?.data?.[0];
        Â  Â  Â  const statusMessage = result?.data?.[1];

        Â  Â  Â  if (Array.isArray(updatedHistoryFromServer)) {
        Â  Â  Â  Â  Â  
        Â  Â  Â  Â  Â  // Re-inject the local image marker into the server's history
        Â  Â  Â  Â  Â  if (imageMarker && updatedHistoryFromServer.length > 0) {
        Â  Â  Â  Â  Â  Â  Â  const lastTurnIndex = updatedHistoryFromServer.length - 1;
        Â  Â  Â  Â  Â  Â  Â  const lastUserMsg = updatedHistoryFromServer[lastTurnIndex][0];
        Â  Â  Â  Â  Â  Â  Â  
        Â  Â  Â  Â  Â  Â  Â  if (lastUserMsg && !lastUserMsg.includes(imageMarker)) {
        Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedHistoryFromServer[lastTurnIndex][0] = lastUserMsg + imageMarker;
        Â  Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  history = updatedHistoryFromServer;
        Â  Â  Â  Â  Â  showStatus(statusMessage || "Received response from OLM.");
        Â  Â  Â  } else {
        Â  Â  Â  Â  Â  // Failure: Rollback the optimistic update
        Â  Â  Â  Â  Â  history.pop();
        Â  Â  Â  Â  Â  showStatus("Error: Invalid response from server.", true);
        Â  Â  Â  Â  Â  throw new Error("Invalid response from OkemoLLM.");
        Â  Â  Â  }
        Â  Â  Â  
        Â  } catch (err) {
        Â  Â  Â  console.error("Prediction error:", err);
        Â  Â  Â  showStatus(`Error: ${err.message || "Unknown error."}`, true);
        Â  Â  Â  
        Â  Â  Â  // Preserve user message on error
        Â  Â  Â  if (history.length > 0 && history[history.length - 1][1] === null) {
        Â  Â  Â  Â  Â  Â history[history.length - 1][1] = "Error: Could not get response.";
        Â  Â  Â  }
        Â  Â  Â  
        Â  } finally {
        Â  Â  Â  loadingBar.classList.add("hidden");
        Â  Â  Â  renderChat(); 
        Â  Â  Â  okemoSendButton.disabled = false;
        Â  Â  Â  okemoSendButton.classList.remove("opacity-50", "cursor-not-allowed");
              // Restore enabled button colors
              okemoSendButton.classList.add("bg-neutral-900", "dark:bg-white", "hover:bg-neutral-800", "dark:hover:bg-neutral-100");
        Â  Â  Â  setTimeout(() => showStatus(""), 1500); 
        Â  Â  Â  
        Â  Â  Â  // Re-enable the toolbox buttons
        Â  Â  Â  const lastTurnToolbox = document.querySelector(`#regenerate-container-${history.length - 1}`);
        Â  Â  Â  if (lastTurnToolbox) {
        Â  Â  Â  Â  Â lastTurnToolbox.querySelectorAll("button").forEach((b) => (b.disabled = false));
        Â  Â  Â  }

        Â  Â  Â  // Final cleanup: clear the file attachment state only for standard sends
        Â  Â  Â  if (isStandardSend) clearFileAttachment();
        Â  }
        }

        // =================================================================================
        // 6. UTILITY ACTIONS (Copy, Export)
        // =================================================================================

        async function copyResponseByTurnIndex(btn, turnIndex) {
        Â  if (turnIndex < 0 || turnIndex >= history.length) {
        Â  Â  showStatus("Invalid message index.", true);
        Â  Â  return;
        Â  }
        Â  const [userMsg, aiMsg] = history[turnIndex];
        Â  
        Â  const cleanUserMsg = userMsg 
        Â  Â  ? userMsg.replace(IMAGE_URL_REGEX, '').replace(FILE_ATTACHMENT_REGEX, '').trim() 
        Â  Â  : '';

        Â  const textToCopy = aiMsg || cleanUserMsg;

        Â  if (!textToCopy) {
        Â  Â  showStatus("Nothing to copy.", true);
        Â  Â  return;
        Â  }
        Â  const originalIconClass = "fa-regular fa-copy";
        Â  const successIconClass = "fa-solid fa-check";
        Â  // Changed success color to neutral-600 for monochrome look
        Â  const successIconColor = "#4b5563"; 
        Â  const iconEl = btn.querySelector("i");
        Â  
        Â  const darkStyle = iconEl.getAttribute('data-dark-style');
        Â  const lightStyle = iconEl.getAttribute('data-light-style');

        Â  try {
        Â  Â  if (navigator.clipboard && navigator.clipboard.writeText) {
        Â  Â  Â  await navigator.clipboard.writeText(textToCopy);
        Â  Â  } else {
        Â  Â  Â  const tempTextarea = document.createElement("textarea");
        Â  Â  Â  tempTextarea.value = textToCopy;
        Â  Â  Â  tempTextarea.style.position = "fixed";
        Â  Â  Â  tempTextarea.style.top = "0";
        Â  Â  Â  tempTextarea.style.left = "0";
        Â  Â  Â  tempTextarea.style.opacity = "0";
        Â  Â  Â  document.body.appendChild(tempTextarea);
        Â  Â  Â  tempTextarea.select();
        Â  Â  Â  tempTextarea.setSelectionRange(0, 99999);
        Â  Â  Â  const successful = document.execCommand("copy");
        Â  Â  Â  document.body.removeChild(tempTextarea);
        Â  Â  Â  if (!successful) throw new Error("Copy command failed.");
        Â  Â  }
        Â  Â  showStatus("Response copied to clipboard! âœ…");
        Â  Â  if (btn) {
        Â  Â  Â  btn.innerHTML = `<i class="${successIconClass} text-sm" style="color: ${successIconColor};" data-dark-style="${darkStyle}" data-light-style="${lightStyle}"></i>`;
        Â  Â  Â  setTimeout(() => {
        Â  Â  Â  Â  btn.innerHTML = `<i class="${originalIconClass} text-sm" data-dark-style="${darkStyle}" data-light-style="${lightStyle}"></i>`;
                 // Manually re-apply the correct theme style after timeout
                 const isDarkMode = document.documentElement.classList.contains("dark");
                 const iconElAfterTimeout = btn.querySelector("i");
                 if(iconElAfterTimeout) {
                     iconElAfterTimeout.setAttribute("style", isDarkMode ? darkStyle : lightStyle);
                 }
        Â  Â  Â  }, 300);
        Â  Â  }
        Â  } catch (err) {
        Â  Â  console.error("Copy failed:", err);
        Â  Â  showStatus("Failed to copy. Please try manually.", true);
        Â  }
        }

        function exportChatHistory(btn) {
        Â  if (history.length === 0) {
        Â  Â  showStatus("No conversation to export. Start chatting first! ðŸ“", true);
        Â  Â  return;
        Â  }
        Â  const originalIconClass = "fa-solid fa-file-export";
        Â  const successIconClass = "fa-solid fa-check";
        Â  // Changed success color to neutral-600 for monochrome look
        Â  const successIconColor = "#4b5563";
        Â  const iconEl = btn.querySelector("i");
        Â  
        Â  const darkStyle = iconEl.getAttribute('data-dark-style');
        Â  const lightStyle = iconEl.getAttribute('data-light-style');
        Â  
        Â  let fileContent = `OkemoLLM Chat Export - ${new Date().toLocaleString()}\n`;
        Â  fileContent += "---------------------------------------\n\n";
        Â  
        Â  history.forEach(([user, assistant]) => {
        Â  Â  // Clean user message of preview markers before exporting
        Â  Â  const cleanUser = user 
        Â  Â  Â  Â  ? user.replace(IMAGE_URL_REGEX, ' [Attached Image]').replace(FILE_ATTACHMENT_REGEX, ' [Attached File]').trim() 
        Â  Â  Â  Â  : '';
        Â  Â  Â  Â  
        Â  Â  if (cleanUser) fileContent += `USER: ${cleanUser}\n`;
        Â  Â  if (assistant) fileContent += `OLM: ${assistant}\n\n`;
        Â  });
        Â  
        Â  const blob = new Blob([fileContent], { type: "text/plain;charset=utf-8" });
        Â  const url = URL.createObjectURL(blob);
        Â  const a = document.createElement("a");
        Â  a.download = `okemo_chat_export_${new Date().toISOString().slice(0, 10)}.txt`;
        Â  a.href = url;
        Â  document.body.appendChild(a);
        Â  a.click();
        Â  document.body.removeChild(a);
        Â  URL.revokeObjectURL(url);
        Â  showStatus("Chat exported successfully! ðŸ“¤");
        Â  
        Â  if (btn) {
        Â  Â  btn.innerHTML = `<i class="${successIconClass} text-sm" style="color: ${successIconColor};" data-dark-style="${darkStyle}" data-light-style="${lightStyle}"></i>`;
        Â  Â  setTimeout(() => {
        Â  Â  Â  btn.innerHTML = `<i class="${originalIconClass} text-sm" data-dark-style="${darkStyle}" data-light-style="${lightStyle}"></i>`;
               // Manually re-apply the correct theme style after timeout
               const isDarkMode = document.documentElement.classList.contains("dark");
               const iconElAfterTimeout = btn.querySelector("i");
               if(iconElAfterTimeout) {
                   iconElAfterTimeout.setAttribute("style", isDarkMode ? darkStyle : lightStyle);
               }
        Â  Â  }, 300);
        Â  }
        Â  setTimeout(() => showStatus(""), 1500); 
        }


        // =================================================================================
        // 7. INPUT BINDINGS & LISTENERS
        // =================================================================================

        function bindInput() {
        Â  if (!textarea) return;
        Â  
        Â  textarea.addEventListener("input", function () {
        Â  Â  this.style.height = "auto";
        Â  Â  const minHeight = 48;
        Â  Â  const newHeight = Math.min(this.scrollHeight, MAX_TEXTAREA_HEIGHT);
        Â  Â  
        Â  Â  this.style.height = `${newHeight}px`;

        Â  Â  // Empty chat prompt visibility
        Â  Â  if (emptyChatPrompt) {
        Â  Â  Â  if (this.value.trim().length > 0) {
        Â  Â  Â  Â  emptyChatPrompt.style.opacity = "0";
        Â  Â  Â  Â  setTimeout(() => emptyChatPrompt.classList.add("hidden"), 300);
        Â  Â  Â  } else if (history.length === 0) {
        Â  Â  Â  Â  emptyChatPrompt.classList.remove("hidden");
        Â  Â  Â  Â  setTimeout(() => emptyChatPrompt.style.opacity = "1", 10); 
        Â  Â  Â  }
        Â  Â  }
        Â  Â  
        Â  Â  // Fix: Explicitly enable/disable the Send button based on content OR file
        Â  Â  const hasText = this.value.trim().length > 0;
        Â  Â  
        Â  Â  if (okemoSendButton) {
        Â  Â  Â  Â  okemoSendButton.disabled = !(hasText || currentFile);

        Â  Â  Â  Â  if (hasText || currentFile) {
        Â  Â  Â  Â  Â  Â  okemoSendButton.classList.remove("opacity-50", "cursor-not-allowed");
        Â  Â  Â  Â  Â  Â  // Add enabled button colors
        Â  Â  Â  Â  Â  Â  okemoSendButton.classList.add("bg-neutral-900", "dark:bg-white", "hover:bg-neutral-800", "dark:hover:bg-neutral-100");
        Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  okemoSendButton.classList.add("opacity-50", "cursor-not-allowed");
        Â  Â  Â  Â  Â  Â  // Remove enabled button colors when disabled
        Â  Â  Â  Â  Â  Â  okemoSendButton.classList.remove("bg-neutral-900", "dark:bg-white", "hover:bg-neutral-800", "dark:hover:bg-neutral-100");
        Â  Â  Â  Â  }
        Â  Â  }
        Â  });

        Â  // Handle Enter key for sending
        Â  textarea.addEventListener("keydown", function(event) {
        Â  Â  if (event.key === 'Enter' && !event.shiftKey) {
        Â  Â  Â  event.preventDefault(); 
        Â  Â  Â  if (okemoSendButton && !okemoSendButton.disabled) {
        Â  Â  Â  Â  sendOkemoMessage();
        Â  Â  Â  }
        Â  Â  }
        Â  });
        }

        function initListeners() {
        Â  initializeElements();
        Â  
        Â  // --- Modals and Toggles ---
        Â  if (disclaimerAgreeButton) disclaimerAgreeButton.addEventListener("click", acceptDisclaimer);
        Â  if (menuToggleButton) menuToggleButton.addEventListener("click", toggleDropdown);
        Â  if (updateNotesLink) updateNotesLink.addEventListener("click", (e) => { e.preventDefault(); showUpdateNotes(); closeDropdown(); });
        Â  if (updateNotesCloseBtn) updateNotesCloseBtn.addEventListener("click", closeUpdateNotes);
        Â  
        Â  // New Chat Handlers
        Â  if (newChatLink1) newChatLink1.addEventListener("click", newChat);
        Â  if (newChatLink2) newChatLink2.addEventListener("click", newChat);
        Â  if (newChatLinkHeader) newChatLinkHeader.addEventListener("click", newChat);
        Â  
        Â  document.addEventListener("click", (e) => {
        Â  Â  const plusMenuToggle = document.getElementById("plus-menu-toggle");
        Â  Â  const inputDropdown = document.getElementById("input-dropdown");

        Â  Â  // Close header dropdown
        Â  Â  if (dropdown && !menuToggleButton.contains(e.target) && !dropdown.contains(e.target)) {
        Â  Â  Â  closeDropdown();
        Â  Â  }
        Â  Â  // Close plus menu dropdown
        Â  Â  if (inputDropdown && plusMenuToggle && !plusMenuToggle.contains(e.target) && !inputDropdown.contains(e.target)) {
        Â  Â  Â  Â  inputDropdown.classList.remove("opacity-100", "scale-y-100");
        Â  Â  Â  Â  inputDropdown.classList.add("opacity-0", "scale-y-0");
        Â  Â  Â  Â  plusMenuToggle.classList.remove("active");
        Â  Â  Â  Â  setTimeout(() => {
        Â  Â  Â  Â  Â  Â  inputDropdown.classList.add("hidden");
        Â  Â  Â  Â  }, 300);
        Â  Â  }

        Â  });

        Â  // --- Main Action Buttons ---
        Â  if (okemoSendButton) {
        Â  Â  const initiallyDisabled = !textarea || (textarea.value.trim().length === 0 && !currentFile);
        Â  Â  okemoSendButton.disabled = initiallyDisabled;
        Â  Â  if (initiallyDisabled) {
        Â  Â  Â  Â  okemoSendButton.classList.add("opacity-50", "cursor-not-allowed");
        Â  Â  }
        Â  Â  okemoSendButton.addEventListener("click", () => sendOkemoMessage());
        Â  }
        Â  
        Â  // --- Plus Menu Toggle ---
        Â  const plusMenuToggle = document.getElementById("plus-menu-toggle");
        Â  const inputDropdown = document.getElementById("input-dropdown");
        Â  if (plusMenuToggle && inputDropdown) {
        Â  Â  Â  plusMenuToggle.addEventListener("click", () => {
        Â  Â  Â  Â  Â  if (inputDropdown.classList.contains("hidden")) {
        Â  Â  Â  Â  Â  Â  Â  inputDropdown.classList.remove("hidden");
        Â  Â  Â  Â  Â  Â  Â  plusMenuToggle.classList.add("active");
        Â  Â  Â  Â  Â  Â  Â  void inputDropdown.offsetWidth;
        Â  Â  Â  Â  Â  Â  Â  inputDropdown.classList.remove("opacity-0", "scale-y-0");
        Â  Â  Â  Â  Â  Â  Â  inputDropdown.classList.add("opacity-100", "scale-y-100");
        Â  Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  Â  Â  inputDropdown.classList.remove("opacity-100", "scale-y-100");
        Â  Â  Â  Â  Â  Â  Â  inputDropdown.classList.add("opacity-0", "scale-y-0");
        Â  Â  Â  Â  Â  Â  Â  plusMenuToggle.classList.remove("active");
        Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
        Â  Â  Â  Â  Â  Â  Â  Â  Â  inputDropdown.classList.add("hidden");
        Â  Â  Â  Â  Â  Â  Â  }, 300);
        Â  Â  Â  Â  Â  }
        Â  Â  Â  });
        Â  }
        Â  
        Â  // --- Web Search Toggle ---
        Â  if (webSearchOption) {
        Â  Â  Â  // Set initial state visually
        Â  Â  Â  updateWebSearchUI(webSearchStatus);
        Â  Â  Â  
        Â  Â  Â  webSearchOption.addEventListener("click", (e) => {
        Â  Â  Â  Â  Â  e.preventDefault();
        Â  Â  Â  Â  Â  // Toggle the status flag and update UI
        Â  Â  Â  Â  Â  updateWebSearchUI(!webSearchStatus, true);
        Â  Â  Â  Â  Â  if (inputDropdown) {
                        inputDropdown.classList.remove("opacity-100", "scale-y-100");
                        inputDropdown.classList.add("opacity-0", "scale-y-0");
                        setTimeout(() => inputDropdown.classList.add("hidden"), 300);
                    }
        Â  Â  Â  Â  Â  if (plusMenuToggle) plusMenuToggle.classList.remove("active");
        Â  Â  Â  });
        Â  }

        Â  // Bind "Upload Photo" button to hidden image input
        Â  if (addImageOption && imageUploadInput) {
        Â  Â  Â  addImageOption.addEventListener("click", () => {
        Â  Â  Â  Â  Â  imageUploadInput.click();
        Â  Â  Â  });
        Â  }

        Â  // Bind "Attach File" button to hidden general file input
        Â  if (newFeatureOption && fileUploadInput) {
        Â  Â  Â  newFeatureOption.addEventListener("click", () => {
        Â  Â  Â  Â  Â  fileUploadInput.click();
        Â  Â  Â  });
        Â  }

        Â  // Handle file selection change for ALL file inputs
        Â  [fileUploadInput, imageUploadInput].forEach(input => {
        Â  Â  if (input) {
        Â  Â  Â  input.addEventListener('change', (e) => {
        Â  Â  Â  Â  const otherInput = (input === fileUploadInput) ? imageUploadInput : fileUploadInput;
        Â  Â  Â  Â  if (otherInput) otherInput.value = ""; 
        Â  Â  Â  Â  
        Â  Â  Â  Â  if (e.target.files.length > 0) {
        Â  Â  Â  Â  Â  const file = e.target.files[0];
        Â  Â  Â  Â  Â  renderFilePreview(file);
        Â  Â  Â  Â  Â  if (textarea) textarea.focus();
        Â  Â  Â  Â  } else {
        Â  Â  Â  Â  Â  renderFilePreview(null);
        Â  Â  Â  Â  }
        Â  Â  Â  Â  if (inputDropdown) inputDropdown.classList.add("hidden");
        Â  Â  Â  Â  if (plusMenuToggle) plusMenuToggle.classList.remove("active");
        Â  Â  Â  Â  
        Â  Â  Â  Â  if(textarea) textarea.dispatchEvent(new Event('input'));
        Â  Â  Â  });
        Â  Â  }
        Â  });

        Â  bindInput();
        }


        // =================================================================================
        // 8. DOCUMENT READY
        // =================================================================================

        document.addEventListener('DOMContentLoaded', () => {
        Â  initListeners();
        Â  checkDisclaimerStatus();
        Â  checkUpdateNotesStatus();
        Â  initOkemo(); 
        });
        
    </script>
</body>
</html>
