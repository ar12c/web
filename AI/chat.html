<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>OLM ENDPOINT</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/179893130?v=4">
    <link rel="apple-touch-icon" href="https://avatars.githubusercontent.com/u/179893130?v=4">

    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://kit.fontawesome.com/40440288c0.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style id="dynamic-accent-styles">
        :root {
            --accent-color: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.4);
            --accent-tint: rgba(59, 130, 246, 0.10);
            --sidebar-tint: rgba(59, 130, 246, 0.07);
            --accent-contrast: #ffffff;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        chatbg: { light: '#ffffff', dark: '#0d0d0d' },
                        sidebar: { light: '#f9f9f9', dark: '#141414' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s ease-in-out infinite',
                        'gradient-flow': 'gradientFlow 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(8px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        pulseGlow: {
                            '0%, 100%': { filter: 'drop-shadow(0 0 6px var(--accent-glow))' },
                            '50%': { filter: 'drop-shadow(0 0 14px var(--accent-glow))' }
                        },
                        gradientFlow: {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * { transition: background-color 0.2s cubic-bezier(0.16, 1, 0.3, 1), border-color 0.2s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.2s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Atmospheric UI Tint - Placed behind UI */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-color: var(--accent-tint);
            pointer-events: none;
            z-index: 0;
        }

        /* Sidebar Tint */
        aside {
            position: relative;
            z-index: 50;
        }
        aside::before {
            content: "";
            position: absolute;
            inset: 0;
            background-color: var(--sidebar-tint);
            pointer-events: none;
            z-index: -1;
        }

        .vail-logo-ai {
            color: var(--accent-color);
            animation: pulseGlow 3s ease-in-out infinite;
        }

        .vail-logo-ai.gradient-mode {
            background: linear-gradient(-45deg, #3b82f6, #22c55e, #a855f7, #ef4444, #3b82f6);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientFlow 4s ease-in-out infinite;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .ai-icon-bubble {
            background-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-glow);
            color: var(--accent-contrast);
            border: none !important;
        }

        .prose { max-width: 100%; color: inherit; font-size: 0.95rem; line-height: 1.7; white-space: normal; overflow-wrap: break-word; }
        .prose b, .prose strong { font-weight: 700; color: currentColor; }
        .prose h1, .prose h2, .prose h3 { font-weight: 800; margin-top: 1.5rem; margin-bottom: 0.75rem; color: currentColor; }
        .prose ul, .prose ol { margin-left: 1.25rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.4rem; }
        .prose li::marker { color: var(--accent-color); font-weight: bold; }

        .prose pre { 
            background: #1a1a1a; padding: 1rem; border-radius: 12px; 
            overflow-x: auto; margin: 1.25rem 0; border: 1px solid rgba(255,255,255,0.05); 
            max-width: 100%; position: relative;
        }
        .dark .prose pre { background: #000; border: 1px solid #222; }
        .prose code { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; background: rgba(0,0,0,0.05); padding: 0.15rem 0.35rem; border-radius: 4px; }
        .dark .prose code { background: rgba(255,255,255,0.1); }

        .katex-display {
            margin: 1rem 0 !important; padding: 1rem;
            background: rgba(0, 0, 0, 0.02); border-radius: 12px;
            overflow-x: auto; max-width: 100%;
        }
        .dark .katex-display { background: rgba(255, 255, 255, 0.02); }

        #sidebar { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.2s ease; }
        body.sidebar-collapsed #sidebar { width: 0 !important; transform: translateX(-100%); opacity: 0; }

        .history-item-active { background: rgba(0, 0, 0, 0.06); font-weight: 600; box-shadow: inset 3px 0 0 var(--accent-color); }
        .dark .history-item-active { background: rgba(255, 255, 255, 0.05); }

        .dropdown-menu { display: none; opacity: 0; transform: translateY(8px) scale(0.99); transition: all 0.15s ease-out; z-index: 100; position: absolute; }
        .dropdown-menu.active { display: block; opacity: 1; transform: translateY(0) scale(1); }

        .accent-dot { width: 1.5rem; height: 1.5rem; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; flex-shrink: 0; }
        .accent-dot.active { border-color: currentColor; transform: scale(1.1); }
        
        #custom-color-input { width: 1.8rem; height: 1.8rem; padding: 0; border: 1px solid rgba(0,0,0,0.1); background: none; cursor: pointer; border-radius: 9999px; overflow: hidden; }

        .input-box-wrap {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-blur: 16px;
            position: relative;
            z-index: 40;
        }
        .dark .input-box-wrap { background-color: rgba(20, 20, 20, 0.9); }
        
        /* Subtle additional tinting for input */
        .input-box-wrap::after {
            content: "";
            position: absolute;
            inset: 0;
            background-color: var(--sidebar-tint);
            pointer-events: none;
            z-index: -1;
            border-radius: 24px;
        }

        main { position: relative; z-index: 10; }
        header { position: relative; z-index: 50; }
    </style>
</head>
<body class="bg-chatbg-light dark:bg-chatbg-dark text-zinc-900 dark:text-zinc-200 font-sans h-full flex overflow-hidden">

    <!-- Mobile Sidebar Backdrop -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/20 dark:bg-black/60 z-[45] hidden opacity-0 transition-opacity duration-300" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 lg:w-64 bg-sidebar-light dark:bg-sidebar-dark border-r border-zinc-200 dark:border-zinc-800/50 flex flex-col transform -translate-x-full lg:translate-x-0 shadow-xl lg:shadow-none">
        <div class="p-4 flex flex-col h-full min-w-[280px] lg:min-w-0">
            <div class="mb-6 px-2 flex items-center justify-between">
                <!-- Branding: Italic V and L theme-aware, AI is gradient or solid pulse -->
                <h1 class="select-none font-black italic text-lg tracking-tight text-zinc-900 dark:text-white uppercase">
                    V<span class="vail-logo-ai gradient-mode" id="logo-ai-core">AI</span>L
                </h1>
                <button class="lg:hidden p-2 text-zinc-400" onclick="toggleSidebar()">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
            </div>

            <!-- New Session Button with Dynamic Contrast -->
            <button id="new-chat-btn" class="w-full flex items-center justify-between gap-3 px-4 py-3 text-sm font-bold rounded-2xl transition-all active:scale-[0.98] mb-4 shadow-lg" style="background-color: var(--accent-color); color: var(--accent-contrast)">
                <span>New Session</span>
                <i class="fa-solid fa-plus text-[10px]"></i>
            </button>

            <div class="flex-1 overflow-y-auto no-scrollbar space-y-1" id="history-list"></div>

            <div class="pt-4 mt-4 border-t border-zinc-200 dark:border-zinc-800 space-y-1">
                <button id="theme-toggle" class="w-full flex items-center gap-3 px-3 py-2.5 text-xs font-semibold rounded-xl hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-all">
                    <i class="fa-solid fa-circle-half-stroke text-zinc-400"></i>
                    <span>Appearance</span>
                </button>
                <button id="clear-all-btn" class="w-full flex items-center gap-3 px-3 py-2.5 text-xs font-semibold text-red-500/80 rounded-xl hover:bg-red-500/5 transition-all">
                    <i class="fa-solid fa-trash-can"></i>
                    <span>Purge Node</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <!-- Top Nav -->
        <header class="h-14 lg:h-12 flex items-center justify-between px-4 lg:px-6 bg-white/40 dark:bg-zinc-900/40 backdrop-blur-xl z-50 border-b border-zinc-100 dark:border-zinc-900/50">
            <div class="flex items-center gap-1 lg:gap-2">
                <button id="sidebar-toggle-btn" onclick="toggleSidebar()" class="p-2 -ml-2 text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 active:scale-90">
                    <i class="fa-solid fa-bars-staggered text-sm"></i>
                </button>
                
                <div class="relative">
                    <button id="model-dropdown-btn" class="flex items-center gap-2 px-2.5 py-1 text-sm font-bold rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all active:scale-95">
                        <div id="active-model-icon" class="w-3.5 h-3.5" style="color: var(--accent-color)"></div>
                        <span id="active-model-name" class="tracking-tight text-zinc-600 dark:text-zinc-400 text-xs lg:text-sm">OLM North Star</span>
                        <i class="fa-solid fa-chevron-down text-[7px] opacity-30"></i>
                    </button>
                    <div id="model-menu" class="dropdown-menu absolute left-0 top-full mt-2 w-64 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 shadow-2xl rounded-2xl overflow-hidden py-1.5">
                        <button id="model-select-pro" class="w-full text-left px-4 py-3 hover:bg-zinc-50 dark:hover:bg-zinc-800 flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <div id="icon-pro-menu" class="w-4 h-4"></div>
                                <div>
                                    <span class="block font-bold text-xs">OLM North Star</span>
                                    <span class="text-[10px] text-zinc-400">Instant synthesis</span>
                                </div>
                            </div>
                            <i class="fa-solid fa-check text-[10px]" style="color: var(--accent-color)" id="check-pro"></i>
                        </button>
                        <button id="model-select-base" disabled class="w-full text-left px-4 py-3 flex items-center justify-between group opacity-40 cursor-not-allowed">
                            <div class="flex items-center gap-3">
                                <div id="icon-base-menu" class="w-4 h-4 text-zinc-400"></div>
                                <div>
                                    <span class="block font-bold text-xs">OLM Stargaze</span>
                                    <span class="text-[10px] text-zinc-500 font-medium">Coming Soon</span>
                                </div>
                            </div>
                            <i class="fa-solid fa-lock text-[9px] text-zinc-400"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-1 lg:gap-2">
                <button id="notes-toggle" class="p-2 text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100">
                    <i class="fa-solid fa-clipboard-list text-xs"></i>
                </button>
                <div id="notes-menu" class="dropdown-menu absolute right-12 lg:right-16 top-14 w-80 bg-white dark:bg-zinc-900 border border-zinc-100 dark:border-zinc-800 shadow-2xl rounded-2xl p-6 overflow-y-auto max-h-[70vh]">
                    <h3 class="font-bold text-[10px] mb-4 text-zinc-400 uppercase tracking-widest">Terminal Log</h3>
                    <div class="space-y-4 text-xs">
                        <div class="border-l-2 border-blue-500 pl-3">
                            <p class="font-bold text-[11px] mb-1">v0.6.1 - Deep Atmosphere</p>
                            <ul class="text-zinc-500 dark:text-zinc-400 space-y-1 list-disc list-inside">
                                <li>Global atmosphere tint deepened to 10%</li>
                                <li>Sidebar atmosphere tint set to 7%</li>
                                <li>Default mode restores rainbow branding</li>
                                <li>Improved contrast logic for custom session actions</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <button id="settings-toggle" class="p-2 text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100">
                    <i class="fa-solid fa-sliders text-xs"></i>
                </button>
                <div id="settings-menu" class="dropdown-menu absolute right-4 top-14 w-72 bg-white dark:bg-zinc-900 border border-zinc-100 dark:border-zinc-800 shadow-2xl rounded-2xl p-5">
                    <h3 class="font-bold text-[10px] mb-4 text-zinc-400 uppercase tracking-widest">Synthesis Config</h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-[10px] font-black mb-2 uppercase">
                                <span>Temperature</span>
                                <span id="temp-val" class="font-mono" style="color: var(--accent-color)">0.70</span>
                            </div>
                            <input type="range" id="param-temp" min="0" max="1" step="0.01" value="0.7" class="w-full h-1 bg-zinc-100 dark:bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-zinc-900 dark:accent-zinc-100">
                        </div>
                        
                        <div>
                            <div class="text-[10px] font-black mb-3 uppercase">System Accent</div>
                            <div class="flex flex-wrap items-center gap-3" id="accent-picker">
                                <div class="accent-dot bg-zinc-900 dark:bg-zinc-100" data-color="auto" title="Default Rainbow"></div>
                                <div class="accent-dot bg-blue-500" data-color="#3b82f6" data-glow="rgba(59, 130, 246, 0.4)"></div>
                                <div class="accent-dot bg-emerald-500" data-color="#10b981" data-glow="rgba(16, 185, 129, 0.4)"></div>
                                <div class="accent-dot bg-purple-500" data-color="#a855f7" data-glow="rgba(168, 85, 247, 0.4)"></div>
                                <div class="accent-dot bg-rose-500" data-color="#f43f5e" data-glow="rgba(244, 63, 94, 0.4)"></div>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-color-input" title="Custom Color">
                                </div>
                            </div>
                        </div>

                        <button id="save-settings" class="w-full py-2.5 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 text-[10px] font-black uppercase rounded-xl active:scale-95 transition-all">Sync Memory</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto no-scrollbar flex flex-col">
            <div id="welcome-state" class="flex-1 flex flex-col items-center justify-center p-6 lg:p-8 text-center animate-fade-in relative">
                <h2 class="text-2xl lg:text-4xl font-semibold mb-10 lg:mb-12 tracking-tight text-zinc-900 dark:text-white">How can OLM help you, Vail?</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-xl">
                    <button class="p-5 rounded-2xl border border-zinc-200 dark:border-zinc-800 text-left bg-white/60 dark:bg-zinc-900/60 hover:bg-white dark:hover:bg-zinc-800/80 active:scale-[0.98] group shadow-sm" onclick="sendMessage('Write a short story about a time traveler who accidentally invents the internet in the middle ages.')">
                        <div class="flex items-center gap-2.5 mb-2">
                            <i class="fa-solid fa-pen-nib text-orange-500 text-xs"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-zinc-500 group-hover:text-zinc-900 dark:group-hover:text-white transition-colors">Creative Story</span>
                        </div>
                        <span class="text-sm font-medium opacity-60 truncate block">Write a short story about a time traveler in the middle ages.</span>
                    </button>
                    <button class="p-5 rounded-2xl border border-zinc-200 dark:border-zinc-800 text-left bg-white/60 dark:bg-zinc-900/60 hover:bg-white dark:hover:bg-zinc-800/80 active:scale-[0.98] group shadow-sm" onclick="window.triggerSampleSearch('Is ketchup considered a smoothie?')">
                        <div class="flex items-center gap-2.5 mb-2">
                            <i class="fa-solid fa-globe text-blue-400 text-xs"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-zinc-500 group-hover:text-zinc-900 dark:group-hover:text-white transition-colors">Global Inquiry</span>
                        </div>
                        <span class="text-sm font-medium opacity-60 truncate block">Is ketchup considered a smoothie?</span>
                    </button>
                </div>
            </div>
            <div id="chat-messages" class="w-full max-w-3xl mx-auto flex flex-col pt-4 pb-48 lg:pb-40 px-5 lg:px-6 relative"></div>
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-0 left-0 w-full px-4 md:px-8 bg-gradient-to-t from-white dark:from-chatbg-dark via-white dark:via-chatbg-dark/95 to-transparent z-40 pb-6 lg:pb-8">
            <div class="input-box-wrap p-1.5 shadow-2xl border border-zinc-200 dark:border-zinc-800 rounded-3xl overflow-hidden">
                <textarea 
                    id="user-input" 
                    placeholder="Prompt OLM..." 
                    rows="1" 
                    class="w-full bg-transparent px-4 py-3 outline-none resize-none text-base lg:text-base max-h-56 no-scrollbar leading-relaxed text-zinc-900 dark:text-white"
                ></textarea>
                
                <div class="flex items-center justify-between px-2 pb-1.5">
                    <div class="flex items-center gap-1.5">
                        <button id="think-toggle" class="flex items-center gap-2 px-3 py-2 rounded-full border border-zinc-100 dark:border-zinc-800 text-[10px] font-bold uppercase tracking-widest text-zinc-400 opacity-40 cursor-not-allowed">
                            <i class="fa-regular fa-lightbulb"></i>
                            <span class="hidden sm:inline">Think</span>
                        </button>
                        <button id="input-search-toggle" class="flex items-center gap-2 px-3 py-2 rounded-full border border-zinc-100 dark:border-zinc-800 text-[10px] font-bold uppercase tracking-widest text-zinc-500 active:scale-95">
                            <i class="fa-solid fa-globe"></i>
                            <span class="hidden sm:inline">Search</span>
                        </button>
                    </div>
                    <div id="send-btn-wrapper">
                        <button id="send-btn" disabled class="w-10 h-10 lg:w-9 lg:h-9 flex items-center justify-center rounded-full active:scale-90 transition-all opacity-50">
                            <i class="fa-solid fa-arrow-up text-[11px]"></i>
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-[9px] font-bold tracking-[0.2em] text-center text-zinc-400 mt-4 opacity-40 uppercase select-none">OLM ENDPOINT RC 0.6.1</p>
        </div>

        <button id="scroll-bottom-btn" class="fixed bottom-40 right-4 lg:right-10 w-11 h-11 rounded-full bg-white dark:bg-zinc-800 border border-zinc-100 dark:border-zinc-700 shadow-2xl flex items-center justify-center transition-all z-40 active:scale-90 text-zinc-500 opacity-0 invisible translate-y-4">
            <i class="fa-solid fa-chevron-down text-xs"></i>
        </button>
    </main>

    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

        const SVG = {
            NORTH: `<svg class="w-full h-full stroke-[2px] stroke-current fill-none" viewBox="0 0 24 24"><path d="M12 2V22M2 12H22M19.07 4.93L4.93 19.07M19.07 19.07L4.93 4.93" /><circle cx="12" cy="12" r="3" class="fill-current stroke-none" /></svg>`,
            STAR: `<svg class="w-full h-full stroke-[2.5px] stroke-current fill-none" viewBox="0 0 24 24"><path d="M12 2L13.5 10.5L22 12L13.5 13.5L12 22L10.5 13.5L2 12L10.5 10.5L12 2Z" /></svg>`
        };

        const MODELS = {
            OLM1: { id: "https://ar12c-okemo2.hf.space", name: "OLM Stargaze", schema: "legacy", icon: SVG.STAR },
            OLM2: { id: "ar12c/OkemoLLM", name: "OLM North Star", schema: "modern", icon: SVG.NORTH }
        };

        let client = null, history = [], isGenerating = false, webSearch = false, thinking = false;
        let currentModel = MODELS.OLM2;
        let currentJob = null; 
        let allChats = JSON.parse(localStorage.getItem('vail_v3_history') || '{}');
        let currentChatId = crypto.randomUUID();
        let settings = JSON.parse(localStorage.getItem('vail_v3_settings') || JSON.stringify({ temp: 0.7, tokens: 2048, top_p: 0.85, penalty: 1.2, accent: 'auto', accentGlow: '' }));

        const els = {
            chatCont: document.getElementById("chat-container"),
            chatMsgs: document.getElementById("chat-messages"),
            input: document.getElementById("user-input"),
            send: document.getElementById("send-btn"),
            status: document.getElementById("api-status"),
            welcome: document.getElementById("welcome-state"),
            hist: document.getElementById("history-list"),
            modMenu: document.getElementById("model-menu"),
            setMenu: document.getElementById("settings-menu"),
            noteMenu: document.getElementById("notes-menu"),
            scroll: document.getElementById('scroll-bottom-btn'),
            search: document.getElementById('input-search-toggle'),
            think: document.getElementById('think-toggle'),
            actIcon: document.getElementById('active-model-icon'),
            backdrop: document.getElementById('sidebar-backdrop'),
            newBtn: document.getElementById('new-chat-btn'),
            logoAi: document.getElementById('logo-ai-core')
        };

        const hexToRgba = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const getLuminance = (hex) => {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            const a = [r, g, b].map(v => v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4));
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        };

        const updateAccent = (color, glow) => {
            let isNeutral = false;
            if (color === 'auto') {
                isNeutral = true;
                color = document.documentElement.classList.contains('dark') ? '#ffffff' : '#000000';
                glow = hexToRgba(color, 0.2);
            }
            
            settings.accent = isNeutral ? 'auto' : color;
            settings.accentGlow = glow;
            localStorage.setItem('vail_v3_settings', JSON.stringify(settings));
            
            // Tint levels: 10% for global atmosphere, 7% for sidebar
            const tintMain = hexToRgba(color, isNeutral ? 0 : 0.10);
            const tintSide = hexToRgba(color, isNeutral ? 0 : 0.07);
            const contrast = getLuminance(color) > 0.5 ? '#1a1a1a' : '#ffffff';
            
            document.getElementById('dynamic-accent-styles').innerHTML = `
                :root {
                    --accent-color: ${color};
                    --accent-glow: ${glow};
                    --accent-tint: ${tintMain};
                    --sidebar-tint: ${tintSide};
                    --accent-contrast: ${contrast};
                }
            `;
            
            if (els.logoAi) {
                els.logoAi.classList.toggle('gradient-mode', isNeutral);
            }

            updateNav();
            renderHistory();
            updateSearchUI();
            updateSendBtnState();

            document.querySelectorAll('.accent-dot').forEach(d => {
                const isActive = (isNeutral && d.dataset.color === 'auto') || (d.dataset.color === color);
                d.classList.toggle('active', isActive);
            });
        };

        const updateNav = () => {
            if (els.actIcon) {
                els.actIcon.innerHTML = currentModel.icon;
                els.actIcon.style.color = 'var(--accent-color)';
            }
            const proMenu = document.getElementById('icon-pro-menu');
            if (proMenu) {
                proMenu.innerHTML = MODELS.OLM2.icon;
                proMenu.style.color = 'var(--accent-color)';
            }
            const modelName = document.getElementById('active-model-name');
            if (modelName) modelName.innerText = currentModel.name;
        };

        const updateSendBtnState = () => {
            const hasText = els.input.value.trim().length > 0;
            if (isGenerating) {
                els.send.disabled = false;
                els.send.innerHTML = `<i class="fa-solid fa-stop text-[11px]"></i>`;
                els.send.className = "w-10 h-10 lg:w-9 lg:h-9 flex items-center justify-center rounded-full bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 active:scale-90 transition-all cursor-pointer shadow-md";
                els.send.style.backgroundColor = ''; 
                els.send.style.color = '';
                els.send.onclick = stopGeneration;
            } else {
                els.send.innerHTML = `<i class="fa-solid fa-arrow-up text-[11px]"></i>`;
                els.send.onclick = () => sendMessage();
                if (hasText) {
                    els.send.disabled = false;
                    els.send.className = "w-10 h-10 lg:w-9 lg:h-9 flex items-center justify-center rounded-full active:scale-90 transition-all shadow-md cursor-pointer";
                    els.send.style.backgroundColor = 'var(--accent-color)';
                    els.send.style.color = 'var(--accent-contrast)';
                } else {
                    els.send.disabled = true;
                    els.send.className = "w-10 h-10 lg:w-9 lg:h-9 flex items-center justify-center rounded-full bg-zinc-100 dark:bg-zinc-800 text-zinc-400 cursor-not-allowed opacity-50";
                    els.send.style.backgroundColor = '';
                    els.send.style.color = '';
                }
            }
        };

        const updateSearchUI = () => {
            els.search.className = `flex items-center gap-2 px-3 py-2 rounded-full border transition-all text-[10px] font-bold uppercase ${webSearch ? 'border-transparent shadow-lg' : 'border-zinc-200 dark:border-zinc-800 text-zinc-500'}`;
            els.search.style.backgroundColor = webSearch ? 'var(--accent-color)' : '';
            els.search.style.color = webSearch ? 'var(--accent-contrast)' : '';
        };

        const stopGeneration = () => {
            if (currentJob) { currentJob.cancel(); currentJob = null; }
            isGenerating = false; 
            updateSendBtnState(); 
            save(); 
            render();
        };

        async function getClient() {
            if (client) return client;
            try { client = await Client.connect(currentModel.id); return client; }
            catch (e) { throw e; }
        }

        const save = () => {
            if (!history.length) return;
            const first = String(history[0][0]).replace("<THINK>", "").replace("<WEB>", "").trim();
            const title = first.substring(0, 30) + (first.length > 30 ? '...' : '');
            const existingPin = allChats[currentChatId]?.pinned || false;
            allChats[currentChatId] = { 
                id: currentChatId, 
                title, 
                history: JSON.parse(JSON.stringify(history)), 
                timestamp: Date.now(), 
                pinned: existingPin 
            };
            localStorage.setItem('vail_v3_history', JSON.stringify(allChats));
            renderHistory();
        };

        async function sendMessage(txt = null) {
            if (isGenerating) return;
            let msg = txt ?? els.input.value.trim();
            if (!msg) return;

            if (!txt) els.input.value = "";
            els.input.style.height = "auto";
            
            if (webSearch) msg += ` <WEB>`;
            if (thinking) msg = `<THINK> ${msg}`;
            
            history.push([msg, null]);
            render(); scrollToBottom();
            isGenerating = true; 
            updateSendBtnState();

            try {
                const c = await getClient();
                const finalPrompt = msg + "\n\nCRITICAL: ALWAYS wrap equations in $$ tags only. No parentheses or square brackets. You are OLM, speaking to Vail. Format using Markdown rich lists and titles.";
                const job = currentModel.schema === "legacy" ? c.submit(0, [finalPrompt, history.map(([u, a]) => [u, a])]) : c.submit(0, [finalPrompt, history.slice(0, -1), settings.temp, settings.top_p, settings.penalty, settings.tokens]);
                currentJob = job;
                
                let cumulativeText = "";
                for await (const chunk of job) {
                    if (!chunk?.data) continue;
                    const rawData = chunk.data[0];
                    if (rawData?.type === 'update') continue;
                    let streamText = (currentModel.schema === "legacy") ? String(rawData[rawData.length - 1][1] || "") : (typeof rawData === 'string' ? rawData : (rawData.text || String(rawData || "")));
                    if (streamText) {
                        cumulativeText = streamText;
                        history[history.length - 1][1] = cumulativeText;
                        const lastProse = els.chatMsgs.querySelector('.ai-row:last-child .prose');
                        if (lastProse) { 
                            lastProse.innerHTML = marked.parse(cumulativeText); 
                            renderMath(lastProse); 
                        }
                        scrollToBottom();
                    }
                }
            } catch (e) {
                if (e.message !== "The user cancelled the request.") {
                    history[history.length - 1][1] = (history[history.length - 1][1] || "") + `\n\n⚠️ OLM interrupt: ${e.message}`;
                    render();
                }
            } finally {
                isGenerating = false; 
                currentJob = null; 
                save(); 
                render(); 
                scrollToBottom(); 
                updateSendBtnState();
            }
        }

        const renderMath = (el) => {
            el.innerHTML = el.innerHTML.replace(/\$\$([\s\S]+?)\$\$/g, (_, f) => `<div class="katex-display">${katex.renderToString(f, { displayMode: true, throwOnError: false })}</div>`);
        };

        const render = () => {
            const hasHistory = history.length > 0;
            els.welcome.style.display = hasHistory ? "none" : "flex";
            els.chatMsgs.style.display = hasHistory ? "flex" : "none";
            if (!hasHistory) return;
            els.chatMsgs.innerHTML = history.map(([u, a], i) => `
                <div class="user-row flex flex-col items-end animate-slide-up" style="animation-delay:${i*0.02}s">
                    <div class="user-msg-bubble">${marked.parse(String(u).replace("<THINK>", "").replace("<WEB>", ""))}</div>
                </div>
                <div class="ai-row flex gap-3 lg:gap-4 animate-slide-up group" style="animation-delay:${(i*0.02)+0.04}s">
                    <div class="w-8 h-8 rounded-full ai-icon-bubble flex items-center justify-center shrink-0">
                         <div class="w-4 h-4">${currentModel.icon}</div>
                    </div>
                    <div class="flex-1 min-w-0 pt-0.5 overflow-hidden">
                        <div class="prose dark:prose-invert">${a ? marked.parse(a) : '<div class="aether-loader"></div>'}</div>
                        ${a ? `<div class="flex gap-4 mt-6 opacity-60">
                            <button onclick="window.__vailCopy(${i})" class="hover:text-blue-500"><i class="fa-regular fa-copy text-xs"></i></button>
                            <button onclick="window.__vailRegen(${i})" class="hover:text-blue-500"><i class="fa-solid fa-rotate-right text-xs"></i></button>
                        </div>` : ''}
                    </div>
                </div>`).join('');
            els.chatMsgs.querySelectorAll('.prose').forEach(renderMath);
        };

        const renderHistory = () => {
            const chats = Object.values(allChats).sort((a, b) => b.timestamp - a.timestamp);
            const pinned = chats.filter(c => c.pinned), archive = chats.filter(c => !c.pinned);
            const now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const yesterday = today - 86400000, last7Days = today - (7 * 86400000);
            let html = "";
            if (pinned.length > 0) {
                html += `<div class="text-[10px] font-bold uppercase tracking-widest px-3.5 mb-2 mt-4 opacity-70" style="color: var(--accent-color)">Pinned</div>`;
                html += pinned.map(c => renderHistoryButton(c)).join('');
            }
            const groups = [{ name: "Today", filter: c => c.timestamp >= today }, { name: "Yesterday", filter: c => c.timestamp >= yesterday && c.timestamp < today }, { name: "Previous 7 Days", filter: c => c.timestamp >= last7Days && c.timestamp < yesterday }, { name: "Older", filter: c => c.timestamp < last7Days }];
            groups.forEach(group => {
                const groupChats = archive.filter(group.filter);
                if (groupChats.length > 0) {
                    html += `<div class="text-[10px] font-bold uppercase tracking-widest text-zinc-400 px-3.5 mb-1.5 mt-5 opacity-40">${group.name}</div>`;
                    html += groupChats.map(c => renderHistoryButton(c)).join('');
                }
            });
            els.hist.innerHTML = html || `<div class="p-8 text-center text-[10px] font-bold uppercase tracking-widest text-zinc-400 opacity-20 mt-10">Empty archive</div>`;
        };

        const renderHistoryButton = (c) => {
            const isActive = c.id === currentChatId;
            return `
                <div class="relative group flex items-center gap-1 px-1 mb-0.5">
                    <button onclick="window.__vailLoad('${c.id}')" class="flex-1 text-left px-3 py-3 rounded-xl text-[13px] font-medium transition-all truncate ${isActive ? 'history-item-active' : 'text-zinc-500 hover:bg-zinc-200/50 dark:hover:bg-zinc-800/50'}">
                        <span class="truncate block pr-16">${c.title}</span>
                    </button>
                    <div class="flex items-center gap-1 shrink-0">
                        <button onclick="event.stopPropagation(); window.__vailTogglePin('${c.id}')" class="w-8 h-8 flex items-center justify-center border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 rounded-xl hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all shadow-sm">
                            <i class="fa-solid fa-thumbtack text-[10px] ${c.pinned ? 'text-blue-500' : 'text-zinc-400 hover:text-blue-400'}"></i>
                        </button>
                        <button onclick="event.stopPropagation(); window.__vailDel('${c.id}')" class="w-8 h-8 flex items-center justify-center border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-all shadow-sm">
                            <i class="fa-solid fa-trash-can text-[10px] text-zinc-400 hover:text-red-500"></i>
                        </button>
                    </div>
                </div>`;
        };

        window.__vailLoad = (id) => { currentChatId = id; history = allChats[id].history; render(); renderHistory(); if (window.innerWidth < 1024) toggleSidebar(); updateSendBtnState(); };
        window.__vailDel = (id) => { delete allChats[id]; localStorage.setItem('vail_v3_history', JSON.stringify(allChats)); if (currentChatId === id) reset(); renderHistory(); };
        window.__vailCopy = (i) => navigator.clipboard.writeText(history[i][1]);
        window.__vailRegen = (i) => { if (isGenerating) return; const m = history[i][0]; history = history.slice(0, i); render(); sendMessage(m); };
        window.__vailTogglePin = (id) => { if (allChats[id]) { allChats[id].pinned = !allChats[id].pinned; localStorage.setItem('vail_v3_history', JSON.stringify(allChats)); renderHistory(); } };

        window.triggerSampleSearch = (text) => {
            if (!webSearch) { webSearch = true; updateSearchUI(); }
            sendMessage(text);
        };

        const reset = () => { currentChatId = crypto.randomUUID(); history = []; isGenerating = false; currentJob = null; render(); renderHistory(); if (window.innerWidth < 1024) toggleSidebar(); updateSendBtnState(); };
        
        window.toggleSidebar = () => {
            const s = document.getElementById('sidebar'), b = els.backdrop;
            const isHidden = s.classList.contains('-translate-x-full');
            if (isHidden) { 
                s.classList.remove('-translate-x-full'); 
                b.classList.remove('hidden'); 
                setTimeout(() => b.style.opacity = '1', 10); 
            } else { 
                s.classList.add('-translate-x-full'); 
                b.style.opacity = '0'; 
                setTimeout(() => b.classList.add('hidden'), 300); 
            }
        };

        const scrollToBottom = () => els.chatCont.scrollTo({ top: els.chatCont.scrollHeight, behavior: 'smooth' });

        function init() {
            if (localStorage.getItem('vail_theme') === 'dark' || (!localStorage.getItem('vail_theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
            
            updateAccent(settings.accent, settings.accentGlow);
            
            els.input.onkeydown = e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); if(!els.send.disabled) els.send.click(); } };
            els.input.oninput = function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 256) + 'px'; updateSendBtnState(); };
            
            document.getElementById('notes-toggle').onclick = e => { e.stopPropagation(); els.modMenu.classList.remove('active'); els.setMenu.classList.remove('active'); els.noteMenu.classList.toggle('active'); };
            document.getElementById('model-dropdown-btn').onclick = e => { e.stopPropagation(); els.setMenu.classList.remove('active'); els.noteMenu.classList.remove('active'); els.modMenu.classList.toggle('active'); };
            document.getElementById('settings-toggle').onclick = e => { e.stopPropagation(); els.modMenu.classList.remove('active'); els.noteMenu.classList.remove('active'); els.setMenu.classList.toggle('active'); };
            window.onclick = () => { els.modMenu.classList.remove('active'); els.setMenu.classList.remove('active'); els.noteMenu.classList.remove('active'); };
            
            document.getElementById('model-select-pro').onclick = () => { currentModel = MODELS.OLM2; client = null; reset(); updateNav(); };
            els.search.onclick = () => { webSearch = !webSearch; updateSearchUI(); };

            document.querySelectorAll('.accent-dot').forEach(dot => {
                dot.onclick = () => {
                    const color = dot.getAttribute('data-color');
                    const glow = dot.getAttribute('data-glow');
                    updateAccent(color, glow);
                };
            });

            document.getElementById('custom-color-input').oninput = (e) => {
                const color = e.target.value;
                updateAccent(color, hexToRgba(color, 0.4));
            };
            
            document.getElementById('theme-toggle').onclick = () => { 
                document.documentElement.classList.toggle('dark'); 
                localStorage.setItem('vail_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                if (settings.accent === 'auto' || settings.accent === '#fff' || settings.accent === '#000') updateAccent('auto', '');
            };
            document.getElementById('new-chat-btn').onclick = reset;
            document.getElementById('save-settings').onclick = () => { 
                settings.temp = parseFloat(document.getElementById('param-temp').value); 
                localStorage.setItem('vail_v3_settings', JSON.stringify(settings)); 
                els.setMenu.classList.remove('active'); 
            };
            document.getElementById('param-temp').oninput = e => { document.getElementById('temp-val').innerText = parseFloat(e.target.value).toFixed(2); };
            document.getElementById('clear-all-btn').onclick = () => { allChats = {}; localStorage.setItem('vail_v3_history', '{}'); reset(); };
            
            els.chatCont.onscroll = () => {
                const s = els.chatCont.scrollHeight - els.chatCont.scrollTop - els.chatCont.clientHeight > 300;
                els.scroll.className = `fixed bottom-40 right-4 lg:right-10 w-11 h-11 rounded-full bg-white dark:bg-zinc-800 border border-zinc-100 dark:border-zinc-700 shadow-2xl flex items-center justify-center transition-all z-40 active:scale-90 text-zinc-500 ${s ? 'opacity-100 visible translate-y-0' : 'opacity-0 invisible translate-y-4'}`;
            };
            els.scroll.onclick = scrollToBottom;
            
            updateNav(); renderHistory(); render(); getClient().catch(() => setStatus("Offline", true));
            updateSendBtnState();
            updateSearchUI();
            window.sendMessage = sendMessage;
        }
        init();
    </script>
</body>
</html>

